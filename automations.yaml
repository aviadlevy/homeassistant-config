- id: night_environment_routine
  alias: Night environment routine
  description: ''
  triggers:
  - at: '18:30:00'
    id: 'on'
    trigger: time
  - id: 'off'
    value_template: '{% if states(''binary_sensor.is_school_vacation'') == ''on''  or
      (is_state(''input_boolean.delay_morning_routine'' ,''on'')) %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline'')) +
      timedelta(minutes = (states(''input_number.morning_vacation_delay'')| int))
      }}

      {% elif states(''input_select.mode'') == ''Shabbat'' %}

      {{ now() >= today_at(states(''input_datetime.shabbat_morning_lights_on'')) -
      timedelta(minutes = 30) }}

      {% else %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline'')) }}

      {% endif %}'
    trigger: template
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Away
  actions:
  - if:
    - condition: trigger
      id:
      - 'on'
    then:
    - data: {}
      target:
        entity_id: switch.smart_plug_kids_bedroom
      action: switch.turn_on
    - action: number.set_value
      metadata: {}
      data:
        value: '10'
      target:
        entity_id: number.dreame_robot_vacuum_d9_volume
    - action: select.select_option
      metadata: {}
      data:
        option: quiet
      target:
        entity_id: select.dreame_robot_vacuum_d9_suction_level
    else:
    - data: {}
      target:
        entity_id: switch.smart_plug_kids_bedroom
      action: switch.turn_off
    - data: {}
      target:
        entity_id:
        - fan.kids_fan
      enabled: true
      action: fan.turn_off
    - data: {}
      target:
        entity_id: light.wled_backlight_tv
      action: light.turn_off
    - if:
      - condition: or
        conditions:
        - condition: state
          entity_id: binary_sensor.is_raining
          state: 'off'
      then:
      - data: {}
        target:
          entity_id: cover.switcher_runner
        action: cover.open_cover
      else:
      - target:
          entity_id:
          - cover.switcher_runner
        data:
          position: 19
        action: cover.set_cover_position
    - action: number.set_value
      metadata: {}
      data:
        value: '50'
      target:
        entity_id: number.dreame_robot_vacuum_d9_volume
    - action: select.select_option
      metadata: {}
      data:
        option: standard
      target:
        entity_id: select.dreame_robot_vacuum_d9_suction_level
  mode: single
- id: backlight_tv
  alias: Backlight TV
  description: ''
  triggers:
  - entity_id:
    - media_player.mitv
    to: 'on'
    id: turn_on
    for:
      hours: 0
      minutes: 0
      seconds: 5
    enabled: true
    trigger: state
  - entity_id:
    - media_player.mitv
    id: turn_off
    from: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 5
    enabled: true
    trigger: state
  conditions: []
  actions:
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - if:
    - condition: trigger
      id: turn_on
    - condition: not
      conditions:
      - condition: state
        entity_id: media_player.mitv_adb
        state: 'off'
    then:
    - condition: state
      entity_id: light.wled_backlight_tv
      state: 'off'
    - wait_for_trigger:
      - entity_id:
        - media_player.mitv_adb
        to: 'on'
        trigger: state
      timeout:
        hours: 0
        minutes: 0
        seconds: 10
        milliseconds: 0
    - data: {}
      target:
        entity_id: input_boolean.hyperion_activation
      action: input_boolean.turn_off
    - data:
        color_temp: 330
        brightness_pct: 50
        effect: Solid
        transition: 10
      target:
        entity_id: light.wled_backlight_tv
      action: light.turn_on
    else:
    - data: {}
      target:
        entity_id: input_boolean.hyperion_activation
      action: input_boolean.turn_off
    - delay:
        hours: 0
        minutes: 0
        seconds: 7
        milliseconds: 0
    - data:
        transition: 20
      target:
        entity_id: light.wled_backlight_tv
      action: light.turn_off
  mode: queued
  max: 10
- id: mode_changer_shabbat
  alias: Mode changer - Shabbat
  description: Turns Shabbos Mode ON/OFF depending on existing mode
  triggers:
  - trigger: time
    at: sensor.jewish_calendar_upcoming_havdalah
    id: 'off'
  - trigger: time
    at:
      entity_id: sensor.jewish_calendar_upcoming_candle_lighting
      offset: -01:00:00
    id: 'on'
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - 'on'
      - condition: state
        entity_id: input_select.mode
        state: Home
      - condition: state
        entity_id: binary_sensor.is_early_shabbat
        state: 'off'
      sequence:
      - delay:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
      - if:
        - condition: state
          entity_id: input_select.mode
          state: Home
        then:
        - target:
            entity_id: input_select.mode
          data:
            option: Shabbat
          action: input_select.select_option
    - conditions:
      - condition: trigger
        id:
        - 'on'
      - condition: state
        entity_id: input_select.mode
        state: Home
      - condition: state
        state: 'on'
        entity_id: binary_sensor.is_early_shabbat
      sequence:
      - target:
          entity_id: input_select.mode
        data:
          option: Shabbat
        action: input_select.select_option
    - conditions:
      - condition: trigger
        id:
        - 'off'
      - condition: state
        entity_id: input_select.mode
        state: Shabbat
      sequence:
      - target:
          entity_id: input_select.mode
        data:
          option: Home
        action: input_select.select_option
      - data: {}
        target:
          entity_id:
          - input_boolean.guests
          - input_boolean.guests_shabbat_dinner
        action: input_boolean.turn_off
      - data: {}
        target:
          entity_id: input_boolean.delay_shabbat
        enabled: true
        action: input_boolean.turn_off
    default: []
  mode: single
- id: mode_changer_away
  alias: Mode changer - Away
  description: Turns Away Mode ON/OFF depending on existing mode
  trigger:
  - platform: state
    entity_id: group.family
  condition: []
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{trigger.to_state.state == ''not_home''}}'
      - condition: state
        entity_id: input_select.mode
        state: Home
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.mode
        data:
          option: Away
    - conditions:
      - condition: template
        value_template: '{{trigger.to_state.state == ''home''}}'
      - condition: state
        entity_id: input_select.mode
        state: Away
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.mode
        data:
          option: Home
    default: []
  mode: single
- id: shabbat_5
  alias: Shabbat 5 - shabbat exists routine
  description: On mode change to shabbat mode, activate the scene and notify
  triggers:
  - entity_id:
    - input_select.mode
    from: Shabbat
    trigger: state
  conditions: []
  actions:
  - data: {}
    action: script.set_up_sonos_group
  - data:
      message: שבת יצאה. שבוע טוב לכולם
      chime_path: choir
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
      - media_player.bedroom_echo_dot
    action: chime_tts.say
  - delay:
      hours: 0
      minutes: 0
      seconds: 10
      milliseconds: 0
  - data: {}
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
      - media_player.sonos_kids_bedroom
    action: media_player.unjoin
  - data:
      message: clear_notification
      data:
        tag: shabbat-mode
    action: notify.mobile_app_aviad_phone
  - metadata: {}
    data:
      volume_level: 0.25
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
    action: media_player.volume_set
  - metadata: {}
    data:
      addon: d5369777_music_assistant
    action: hassio.addon_start
  mode: single
- id: lights_out
  alias: Lights out
  description: ''
  triggers:
  - at: 08:00:00
    trigger: time
  - at: 09:00:00
    trigger: time
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      enabled: true
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
    - condition: state
      entity_id: person.noga
      state: home
  actions:
  - variables:
      current_bedroom_fan_state: '{{ states(''fan.bedroom_fan'') }}'
  - target:
      entity_id: scene.lights_out
    metadata: {}
    action: scene.turn_on
    data: {}
  - action: climate.turn_off
    metadata: {}
    target:
      entity_id: climate.kids_bedroom
    data: {}
  - if:
    - condition: state
      entity_id: binary_sensor.bedroom_occupancy_sensor_occupancy
      state: 'on'
    then:
    - metadata: {}
      data: {}
      target:
        entity_id: fan.bedroom_fan
      action: fan.turn_{{ current_bedroom_fan_state }}
  mode: single
- id: bed_md
  alias: Bed motion detection
  description: ''
  triggers:
  - from: 'off'
    to: 'on'
    entity_id: binary_sensor.bed_motion_sensor
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: sun.sun
    state: below_horizon
  - condition: and
    conditions:
    - condition: or
      conditions:
      - condition: state
        entity_id: media_player.projector
        state: unavailable
      - condition: state
        entity_id: media_player.projector
        state: 'off'
    - condition: or
      conditions:
      - condition: state
        entity_id: remote.mibox3
        state: unavailable
      - condition: state
        entity_id: remote.mibox3
        state: 'off'
  actions:
  - data: {}
    target:
      entity_id: light.bed_led_strip
    action: light.turn_on
  - wait_for_trigger:
    - from: 'on'
      to: 'off'
      entity_id: binary_sensor.bed_motion_sensor
      trigger: state
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - delay:
      hours: 0
      minutes: 0
      seconds: 40
      milliseconds: 0
  - data: {}
    target:
      entity_id: light.bed_led_strip
    action: light.turn_off
  mode: restart
- id: light_on_door
  alias: Lights on when opening door
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.door_sensor
    to: 'on'
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: or
    conditions:
    - condition: state
      state: below_horizon
      entity_id: sun.sun
    - condition: numeric_state
      entity_id: cover.switcher_runner
      below: 10
      attribute: current_position
  actions:
  - action: scene.create
    metadata: {}
    data:
      scene_id: before_door
      snapshot_entities:
      - light.wled_kitchen
  - data:
      kelvin: 5390
      effect: solid
      brightness_pct: 75
    target:
      entity_id:
      - light.entrance_bulb
      - light.wled_kitchen
    action: light.turn_on
  - continue_on_error: true
    data:
      kelvin: 2070
    target:
      entity_id:
      - light.small_kids_bedroom
      - light.bathroom_bulb
    action: light.turn_on
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.door_sensor
      trigger: state
      to: 'off'
      for:
        hours: 0
        minutes: 0
        seconds: 5
    timeout:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - delay:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
  - data: {}
    target:
      entity_id:
      - light.entrance_bulb
    action: light.turn_off
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_door
  - action: scene.delete
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_door
  mode: single
- id: shabbat_1
  alias: Shabbat 1 - candle light plag
  description: ''
  triggers:
  - value_template: '{{ as_timestamp(states(''sensor.jewish_calendar_plag_hamincha''))|timestamp_custom(''%H:%M'',
      true) == as_timestamp(now())|timestamp_custom(''%H:%M'', true) }}'
    trigger: template
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: state
    entity_id: binary_sensor.is_early_shabbat
    state: 'on'
  - condition: not
    conditions:
    - condition: time
      weekday:
      - sat
  actions:
  - data:
      message: זמן הדלקת נרות
      chime_path: choir
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
      - media_player.bedroom_echo_dot
    action: chime_tts.say
  mode: single
- id: alert_high_temp
  alias: Alert when high temperature
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.processor_temperature
    for:
      hours: 0
      minutes: 10
      seconds: 0
    above: 67
  condition: []
  action:
  - service: notify.mobile_app_aviad_phone
    data:
      message: Temperature is {{ states("sensor.processor_temperature") }}
      title: Temperature is too high
  mode: single
- id: alert_omer
  alias: Alert when Sfirat HaOmer
  description: ''
  triggers:
  - entity_id:
    - sensor.jewish_calendar_day_of_the_omer
    for:
      hours: 0
      minutes: 36
      seconds: 0
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: sensor.jewish_calendar_day_of_the_omer
      state: '0'
  - condition: not
    conditions:
    - condition: template
      value_template: '{{trigger.from_state.state == ''unknown''}}'
  actions:
  - variables:
      message: '{% set totalDays = states(''sensor.jewish_calendar_day_of_the_omer'')
        | int %}{% set weeks = totalDays // 7 %}{% set daysInWeek = totalDays %7 %}{%
        set lsb = totalDays % 10 %}{% set msb = totalDays - lsb %}הַיּוֹם{% if totalDays
        == 1 %} יוֹם אֶחָד{% elif totalDays > 1 and totalDays < 7 %}{{ totalDays }}
        יָמִים{% else %} {% if totalDays < 21 or lsb == 0 %}{{ totalDays }}{% else
        %}{{ lsb }} וְ- {{ msb }}{% endif %} {% if totalDays < 11 %} יָמִים {% else
        %} יוֹם {% endif %} {% if weeks < 2 %}שֶׁהֵם שָׁבוּעַ אֶחָד {% else %}שֶׁהֵם
        {{ weeks }} שָׁבוּעוֹת {% endif %} {% if daysInWeek == 1 %}וְיוֹם אֶחָד {%
        elif daysInWeek > 1 %}וְ- {{ daysInWeek }} יָמִים {% endif %}{% endif %}לָעומֶר

        '
    enabled: false
  - action: jewish_calendar.count_omer
    data:
      nusach: sfarad
    response_variable: omer
    enabled: true
  - data:
      message: '{{ omer[''message''] }}

        '
    action: notify.home_assistant_telegram
  - data:
      chime_path: toast
      offset: 1000
      announce: true
      language: iw
      tts_platform: google_translate
      cache: true
      message: '{{ omer[''message''] | replace(''לעומר'',''לה-עומר'') }}'
    target:
      entity_id: media_player.sonos_living_room
    enabled: true
    action: chime_tts.say
  mode: single
- id: alert_washing_machine_finished
  alias: Fire event when washing machine finished
  description: ''
  triggers:
  - entity_id: sensor.washing_machine_socket_power
    for:
      minutes: 5
    above: 5
    trigger: numeric_state
  - trigger: homeassistant
    event: start
  conditions:
  - condition: numeric_state
    entity_id: sensor.washing_machine_socket_power
    above: 5
  actions:
  - wait_for_trigger:
    - entity_id: sensor.washing_machine_socket_power
      below: 3
      for:
        minutes: 4
      trigger: numeric_state
  - if:
    - condition: state
      entity_id: binary_sensor.washing_machine_contact_sensor
      state: 'off'
    then:
    - event: washing_machine_finished
      event_data: {}
  mode: single
  max_exceeded: silent
- id: alert_phone_low_battery_aviad
  alias: Alert when phone low battery - Aviad
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.aviad_phone_battery_level
    below: input_number.low_battery_level_aviad
  - platform: state
    entity_id:
    - binary_sensor.aviad_phone_is_charging
    to: 'off'
    for:
      hours: 0
      minutes: 15
      seconds: 0
  condition:
  - condition: state
    entity_id: sun.sun
    state: above_horizon
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  - condition: state
    entity_id: binary_sensor.aviad_phone_is_charging
    state: 'off'
  - condition: numeric_state
    entity_id: sensor.aviad_phone_battery_level
    below: input_number.low_battery_level_aviad
  action:
  - repeat:
      until:
      - condition: or
        conditions:
        - condition: state
          entity_id: binary_sensor.aviad_phone_is_charging
          state: 'on'
        - condition: state
          entity_id: input_select.mode
          state: Shabbat
        - condition: numeric_state
          entity_id: sensor.aviad_phone_battery_level
          above: input_number.low_battery_level_aviad
        - condition: state
          entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
          state: 'on'
      sequence:
      - data:
          message: clear_notification
          data:
            tag: aviad_low_battery
        action: notify.mobile_app_aviad_phone
      - data:
          message: Low battery
          data:
            actions:
            - action: long_snooze_low_battery_notification
              title: Longer Snooze
            tag: aviad_low_battery
        action: notify.mobile_app_aviad_phone
      - delay:
          hours: 0
          minutes: 20
          seconds: 0
          milliseconds: 0
      - if:
        - condition: state
          entity_id: input_boolean.longer_low_battery_snooze
          state: 'on'
        then:
        - delay:
            hours: 0
            minutes: 40
            seconds: 0
            milliseconds: 0
        - data: {}
          target:
            entity_id: input_boolean.longer_low_battery_snooze
          action: input_boolean.turn_off
  mode: single
- id: alert_phone_low_battery_noga
  alias: Alert when phone low battery - Noga
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.noga_phone_battery_level
    below: 40
  condition:
  - condition: state
    entity_id: sun.sun
    state: above_horizon
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  - condition: state
    entity_id: binary_sensor.noga_phone_is_charging
    state: 'off'
  action:
  - service: notify.mobile_app_noga_phone
    data:
      message: Low battery
  mode: single
- id: tag_scanned_parent_bathroom
  alias: Tag parent bathroom is scanned
  description: ''
  trigger:
  - platform: tag
    tag_id: 17137ac4-9193-4ce7-a194-43126a8b63b9
  condition: []
  action:
  - service: light.toggle
    data: {}
    target:
      entity_id: light.parents_bathroom_lights
  mode: single
- id: lights_washing_machine_finished
  alias: When washing machine finished
  description: ''
  triggers:
  - event_type: washing_machine_finished
    trigger: event
  conditions: []
  actions:
  - data:
      message: מכונת הכביסה סיימה
    action: notify.mobile_app_noga_phone
  - data:
      rgb_color:
      - 17
      - 0
      - 255
    target:
      entity_id: light.balcony_bulb
    action: light.turn_on
  - if:
    - condition: time
      before: 07:05:00
    then:
    - wait_for_trigger:
      - trigger: time
        at: 07:05:00
  - parallel:
    - repeat:
        until:
        - condition: or
          conditions:
          - condition: state
            entity_id: binary_sensor.washing_machine_contact_sensor
            state: 'on'
          - condition: state
            entity_id: input_boolean.washing_machine_tag_scanned
            state: 'on'
        sequence:
        - if:
          - condition: state
            entity_id: media_player.mitv_adb
            state: playing
          then:
          - data:
              message: מכונת הכביסה סיימה
            action: notify.mi_tv
          - target:
              entity_id: media_player.sonos_kitchen
            data:
              offset: 500
              announce: true
              language: iw
              message: מכונת הכביסה סיימה
              tts_platform: google_translate
              chime_path: chord
              cache: true
            enabled: true
            action: chime_tts.say
          else:
          - target:
              entity_id:
              - media_player.sonos_kitchen
              - media_player.sonos_living_room
            data:
              offset: 500
              announce: true
              language: iw
              message: מכונת הכביסה סיימה
              tts_platform: google_translate
              chime_path: chord
              join_players: true
              cache: true
              unjoin_players: true
            enabled: true
            action: chime_tts.say
        - delay:
            hours: 0
            minutes: 10
            seconds: 0
            milliseconds: 0
    - sequence:
      - wait_for_trigger:
        - entity_id:
          - binary_sensor.washing_machine_contact_sensor
          to: 'on'
          trigger: state
        - tag_id: 93d413b2-e019-43c7-a394-ad8db3bc8f34
          trigger: tag
        timeout:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
      - data:
          color_temp: 153
          brightness_pct: 100
        target:
          entity_id: light.balcony_bulb
        action: light.turn_on
      - if:
        - condition: state
          entity_id: sun.sun
          state: above_horizon
        then:
        - delay:
            hours: 0
            minutes: 0
            seconds: 5
            milliseconds: 0
        else:
        - delay:
            hours: 0
            minutes: 30
            seconds: 0
            milliseconds: 0
      - data: {}
        target:
          entity_id: light.balcony_bulb
        action: light.turn_off
  mode: single
- id: shabbat_guests
  alias: Guests for Shabbat
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.guests
    to: 'on'
  condition: []
  action:
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.guests_shabbat_dinner
  mode: single
- id: shabbat_2
  alias: Shabbat 2 - lights scenes
  description: ''
  triggers:
  - event: sunset
    offset: '1:00:00'
    id: shabbat_1_evening_house
    trigger: sun
  - id: shabbat_2_night_house
    at: input_datetime.shabbat_lights_out
    trigger: time
  - at: input_datetime.shabbat_morning_lights_on
    id: shabbat_3_morning_house
    enabled: true
    trigger: time
  - at: '10:30:00'
    id: shabbat_3_morning_meal
    enabled: true
    trigger: time
  - at: input_datetime.shabbat_noon_lights_out
    id: shabbat_4_day_house
    enabled: true
    trigger: time
  - event: sunset
    offset: -01:30:00
    id: shabbat_5_sunset_house
    enabled: true
    trigger: sun
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: shabbat_1_evening_house
      - condition: time
        after: 00:00:00
        before: input_datetime.shabbat_lights_out
      sequence:
      - if:
        - condition: state
          entity_id: binary_sensor.is_early_shabbat
          state: 'off'
        then:
        - delay:
            hours: 1
            minutes: 0
            seconds: 0
            milliseconds: 0
        else: []
      - if:
        - condition: time
          before: input_datetime.shabbat_night_baseline_routine
          after: 00:00:00
        then:
        - wait_for_trigger:
          - at: input_datetime.shabbat_night_baseline_routine
            trigger: time
        else: []
      - if:
        - condition: state
          entity_id: input_boolean.guests_shabbat_dinner
          state: 'on'
        then:
        - delay:
            hours: 1
            minutes: 30
            seconds: 0
            milliseconds: 0
        else: []
      - if:
        - condition: time
          after: 00:00:00
          before: input_datetime.shabbat_lights_out
        then:
        - action: scene.turn_on
          target:
            entity_id: scene.shabbat_1_evening
        - data: {}
          target:
            entity_id: light.bed_led_strip
          action: light.turn_on
    - conditions:
      - condition: trigger
        id: shabbat_2_night_house
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.shabbat_2_goodnight
      - target:
          entity_id: cover.switcher_runner
        data:
          position: 9
        action: cover.set_cover_position
    - conditions:
      - condition: trigger
        id: shabbat_3_morning_house
      sequence:
      - if:
        - condition: or
          conditions:
          - condition: numeric_state
            entity_id: sensor.average_cloudiness_1h
            above: 60
          - condition: numeric_state
            entity_id: sensor.pirateweather_cloud_coverage
            above: 60
          - condition: numeric_state
            entity_id: cover.switcher_runner
            attribute: current_position
            below: 20
        then:
        - target:
            entity_id: scene.shabbat_3_morning_cloudy
          metadata: {}
          action: scene.turn_on
        else:
        - target:
            entity_id: scene.shabbat_3_morning
          metadata: {}
          action: scene.turn_on
    - conditions:
      - condition: trigger
        id: shabbat_3_morning_meal
      sequence:
      - if:
        - condition: or
          conditions:
          - condition: numeric_state
            entity_id: sensor.average_cloudiness_1h
            above: 60
          - condition: numeric_state
            entity_id: sensor.pirateweather_cloud_coverage
            above: 60
          - condition: numeric_state
            entity_id: cover.switcher_runner
            attribute: current_position
            below: 20
        then:
        - target:
            entity_id: scene.shabbat_3_morning_cloudy
          metadata: {}
          action: scene.turn_on
    - conditions:
      - condition: trigger
        id: shabbat_4_day_house
      - condition: numeric_state
        entity_id: cover.switcher_runner
        attribute: current_position
        above: 20
      - condition: numeric_state
        entity_id: sensor.average_cloudiness_1h
        below: 60
      - condition: numeric_state
        entity_id: sensor.pirateweather_cloud_coverage
        below: 60
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.shabbat_2_goodnight
    - conditions:
      - condition: trigger
        id: shabbat_5_sunset_house
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.shabbat_0_sunset
    default: []
  mode: queued
  max: 10
- id: shabbat_3
  alias: Shabbat 3 - fans scenes
  description: ''
  triggers:
  - entity_id:
    - input_select.mode
    to: Shabbat
    id: no_fans
    enabled: true
    trigger: state
  - at: '21:40:00'
    id: bedroom_fans
    enabled: false
    trigger: time
  - at: '23:20:00'
    id: bedroom_fans
    enabled: false
    trigger: time
  - at: 07:00:00
    id: all_fans
    enabled: false
    trigger: time
  - at: '10:07:00'
    enabled: true
    id: living_room_fan
    trigger: time
  - at: '12:00:00'
    id: all_fans
    enabled: true
    trigger: time
  - enabled: true
    id: no_fans
    event: sunset
    offset: -01:30:00
    trigger: sun
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: all_fans
      sequence:
      - target:
          entity_id: scene.shabbat_fans_on
        metadata: {}
        action: scene.turn_on
        data: {}
      - if:
        - condition: state
          entity_id: input_boolean.guests
          state: 'on'
        then:
        - data: {}
          target:
            entity_id: fan.office_fan
          action: fan.turn_on
    - conditions:
      - condition: trigger
        id: bedroom_fans
      sequence:
      - target:
          entity_id: scene.shabbat_bedroom_fans_on
        metadata: {}
        action: scene.turn_on
        data: {}
      - if:
        - condition: state
          entity_id: input_boolean.guests
          state: 'on'
        then:
        - data: {}
          target:
            entity_id: fan.office_fan
          action: fan.turn_on
    - conditions:
      - condition: trigger
        id: no_fans
      sequence:
      - target:
          entity_id: scene.fans_out
        metadata: {}
        action: scene.turn_on
        data: {}
    - conditions:
      - condition: trigger
        id: living_room_fan
      sequence:
      - target:
          entity_id: scene.shabbat_living_room_fans_on
        metadata: {}
        action: scene.turn_on
        data: {}
    default: []
  mode: single
- id: tag_scanned_waching_machine
  alias: Washing machine tag state
  description: ''
  trigger:
  - platform: tag
    tag_id: 93d413b2-e019-43c7-a394-ad8db3bc8f34
  condition: []
  action:
  - service: light.turn_on
    data:
      color_temp: 153
      brightness_pct: 100
    target:
      entity_id: light.balcony_bulb
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.washing_machine_tag_scanned
  - delay:
      hours: 0
      minutes: 40
      seconds: 0
      milliseconds: 0
  - service: input_boolean.turn_off
    data: {}
    target:
      entity_id: input_boolean.washing_machine_tag_scanned
  mode: single
- id: zigbee_switch_balcony
  alias: Zigbee balcony switch automation
  description: ''
  use_blueprint:
    path: homeassistant/sonoff_switch.yaml
    input:
      sonoff_button: 32b1a46b19821e2f7655e149ba39da85
      toggle_action:
      - data:
          color_temp: 153
          brightness_pct: 100
          color_temp_kelvin: 6500
        target:
          entity_id: light.balcony_bulb
        action: light.toggle
      on_action:
      - data:
          color_temp: 153
        target:
          entity_id: light.balcony_bulb
        action: light.turn_on
- id: zigbee_switch_parents_bathroom
  alias: Zigbee parents bathroom switch automation
  description: ''
  use_blueprint:
    path: homeassistant/sonoff_switch.yaml
    input:
      sonoff_button: aae1c5bf1cd8c2ed601df34d695457a4
      toggle_action:
      - service: light.toggle
        data: {}
        target:
          entity_id:
          - light.parent_bathroom_bulb
      on_action:
      - service: light.toggle
        data: {}
        target:
          entity_id: light.parents_bathroom_lights
      off_action:
      - service: light.turn_on
        data: {}
        target:
          entity_id: light.parents_bathroom_lights
- id: alert_download_finished
  alias: Alert when download is finished
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.qbittorrent_down_speed
    for:
      hours: 0
      minutes: 10
      seconds: 0
    below: 1
  condition:
  - condition: template
    value_template: '{{trigger.from_state.state != ''unavailable''}}'
  action:
  - service: notify.mobile_app_aviad_phone
    data:
      message: Download completed
      title: Qbittorent
      data:
        actions:
        - action: URI
          title: Open Qbittorrent
          uri: /db21ed7f_qbittorrent/dashboard
        tag: download-finished
  mode: restart
- id: ble_transimitter_active_when_home
  alias: BLE transmitter active only at home
  description: ''
  trigger:
  - platform: state
    entity_id:
    - device_tracker.aviad_phone
    for:
      hours: 0
      minutes: 3
      seconds: 0
    from: home
    to: not_home
  - platform: state
    entity_id:
    - device_tracker.aviad_phone
    from: not_home
    to: home
    for:
      hours: 0
      minutes: 3
      seconds: 0
  condition: []
  action:
  - if:
    - condition: state
      entity_id: device_tracker.aviad_phone
      state: not_home
      for:
        hours: 0
        minutes: 0
        seconds: 0
    then:
    - service: notify.mobile_app_aviad_phone
      data:
        message: command_ble_transmitter
        data:
          command: turn_off
    else:
    - service: notify.mobile_app_aviad_phone
      data:
        message: command_ble_transmitter
        data:
          command: turn_on
  mode: single
- id: showert_morning
  alias: Shower in the morning
  description: ''
  triggers:
  - at: 06:15:00
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: state
    entity_id: input_boolean.morning_shower
    state: 'on'
  actions:
  - data:
      timer_minutes: 30
    target:
      entity_id: switch.switcher_home
    action: switcher_kis.turn_on_with_timer
  - data: {}
    target:
      entity_id: input_boolean.morning_shower
    action: input_boolean.turn_off
  mode: single
- id: vacuum_when_away
  alias: Vacuum when away
  description: ''
  triggers:
  - entity_id:
    - input_select.mode
    to: Away
    for:
      hours: 0
      minutes: 10
      seconds: 0
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.vacuum_when_away
    state: 'on'
  actions:
  - data:
      segments:
      - 6
      - 4
      - 10
    target:
      entity_id: vacuum.dreame_robot_vacuum_d9
    action: dreame_vacuum.vacuum_clean_segment
  - data: {}
    target:
      entity_id: input_boolean.vacuum_when_away
    action: input_boolean.turn_off
  mode: single
- id: kids_heater_routine
  alias: Kids heater climate routine
  description: ''
  trigger:
  - platform: state
    entity_id:
    - schedule.kids_heater_climate_scheduler
    to: 'on'
    from: 'off'
    id: to_on
  - platform: state
    entity_id:
    - schedule.kids_heater_climate_scheduler
    to: 'off'
    from: 'on'
    id: to_off
  condition:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id: to_on
      - condition: not
        conditions:
        - condition: state
          entity_id: input_select.mode
          state: Away
    - condition: trigger
      id: to_off
  action:
  - service: climate.turn_{{ trigger.to_state.state }}
    data: {}
    target:
      entity_id: climate.kids_bedroom
  mode: single
- id: kids_heater_switch
  alias: Kids heater climate - connect to switch
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.smart_plug_il
    to: 'on'
    from: 'off'
    id: to_on
  condition:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id: to_on
      - condition: not
        conditions:
        - condition: state
          entity_id: input_select.mode
          state: Away
    - condition: trigger
      id: to_off
  action:
  - service: climate.turn_{{ trigger.to_state.state }}
    data: {}
    target:
      entity_id: climate.kids_bedroom
  mode: single
- id: mobile_event_longer_battery_notification_snooze
  alias: Mobile Event Fired - Longer low notification snooze
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: long_snooze_low_battery_notification
  condition: []
  action:
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.longer_low_battery_snooze
  mode: single
- id: kids_heater_hass_restart
  alias: Kids heater when home assistant restart
  description: ''
  triggers:
  - event: start
    trigger: homeassistant
  - trigger: state
    entity_id:
    - input_select.mode
    to: Home
  conditions:
  - condition: and
    conditions:
    - condition: not
      conditions:
      - condition: state
        entity_id: input_select.mode
        state: Away
    - condition: state
      entity_id: schedule.kids_heater_climate_scheduler
      state: 'on'
  actions:
  - data: {}
    target:
      entity_id: climate.kids_bedroom
    action: climate.turn_on
  mode: single
- id: alert_cloudy_day
  alias: Alert when cluody day
  description: ''
  triggers:
  - at: '16:30:00'
    trigger: time
    id: weekday
  - trigger: time
    at: '11:30:00'
    id: Friday
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  - condition: numeric_state
    entity_id: sensor.average_cloudiness_8h
    above: 65
  - condition: state
    entity_id: switch.switcher_home
    state: 'off'
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id:
        - Friday
      - condition: time
        weekday:
        - fri
    - condition: and
      conditions:
      - condition: trigger
        id:
        - weekday
      - condition: time
        weekday:
        - thu
        - wed
        - tue
        - mon
        - sun
  actions:
  - data:
      message: We had {{states('sensor.average_cloudiness_8h')}} % average cloud coverage
        for the last 8h
      data:
        actions:
        - action: turn_on_boiler_notification
          title: Turn on boiler for 30min
        - action: boiler_dismiss
          title: Dismiss
        tag: cloudy-day-alert
      title: Cloudy day
    action: notify.aviad_and_noga_mobiles
  - wait_for_trigger:
    - event_type: mobile_app_notification_action
      event_data:
        tag: cloudy-day-alert
      trigger: event
    timeout:
      hours: 1
      minutes: 30
      seconds: 0
      milliseconds: 0
  - if:
    - condition: template
      value_template: '{{ wait.trigger and wait.trigger.event.data.action == ''turn_on_boiler_notification''
        }}'
    then:
    - data:
        timer_minutes: 30
      target:
        entity_id: switch.switcher_home
      action: switcher_kis.turn_on_with_timer
  - data:
      message: clear_notification
      data:
        tag: cloudy-day-alert
    action: notify.aviad_and_noga_mobiles
  mode: single
- id: backlight_tv_music
  alias: Backlight TV Music
  description: ''
  triggers:
  - entity_id:
    - media_player.sonos_living_room
    for:
      hours: 0
      minutes: 0
      seconds: 5
    to: playing
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.sonos_living_room
      attribute: source
      state: TV
  actions:
  - action: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.wled_backlight_tv_sync_send
      - switch.wled_kitchen_sync_receive
  - data:
      effect: '{{ state_attr("light.wled_backlight_tv", "effect_list")[1:118] | reject("equalto",
        "RSVD") | list | random }}'
    target:
      entity_id: light.wled_backlight_tv
    action: light.turn_on
  - target:
      entity_id: select.wled_backlight_tv_color_palette
    data:
      option: '{{ state_attr(''select.wled_backlight_tv_color_palette'', ''options'')
        | random }}'
    action: select.select_option
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      from: playing
      for:
        hours: 0
        minutes: 0
        seconds: 7
      trigger: state
    timeout:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - data: {}
    target:
      entity_id: light.wled_backlight_tv
    action: light.turn_off
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.wled_backlight_tv_sync_send
      - switch.wled_kitchen_sync_receive
  mode: restart
- id: hyperion_activation
  alias: Hyperion Activation
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.hyperion_activation
    from: 'on'
    to: 'off'
  - platform: state
    entity_id:
    - input_boolean.hyperion_activation
    from: 'off'
    to: 'on'
  condition: []
  action:
  - if:
    - condition: state
      entity_id: input_boolean.hyperion_activation
      state: 'on'
    then:
    - service: script.activate_hyperion
      data: {}
    else:
    - service: script.disable_hyperion
      data: {}
  mode: single
- id: alert_noga_heading_home
  alias: Alert when Noga is heading home
  description: ''
  triggers:
  - entity_id:
    - sensor.noga_distance
    for:
      hours: 0
      minutes: 0
      seconds: 0
    below: 2
    trigger: numeric_state
  - entity_id:
    - sensor.noga_direction_of_travel
    to: towards
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  conditions:
  - condition: state
    state: towards
    entity_id: sensor.noga_direction_of_travel
  - condition: numeric_state
    entity_id: sensor.noga_to_aviad_proximity
    above: 1
    enabled: true
  actions:
  - data:
      message: 'Distance: {{ states.sensor.noga_distance.state }} km. Waze time: {{
        states(''sensor.waze_travel_noga'') | round(2) }}'
      title: Noga is heading home
      data:
        tag: noga-headed-home
    action: notify.mobile_app_aviad_phone
  mode: single
- id: office_md
  alias: Office motion detection
  description: ''
  triggers:
  - from: 'off'
    to: 'on'
    entity_id:
    - binary_sensor.office_occupancy_sensor_occupancy
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: sun.sun
    state: below_horizon
  - condition: state
    entity_id: input_boolean.guests
    state: 'off'
  actions:
  - data:
      rgb_color:
      - 17
      - 0
      - 255
      brightness_pct: 50
    target:
      entity_id:
      - light.office_desk_light
    action: light.turn_on
  - wait_for_trigger:
    - from: 'on'
      to: 'off'
      entity_id:
      - binary_sensor.office_occupancy_sensor_occupancy
      trigger: state
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - delay:
      hours: 0
      minutes: 0
      seconds: 40
      milliseconds: 0
  - data: {}
    target:
      entity_id:
      - light.office_desk_light
    action: light.turn_off
  mode: restart
- id: one_time_automation_noga_home
  alias: One-time automation - Alert
  description: ''
  triggers:
  - entity_id:
    - person.aviad
    to: home
    enabled: true
    trigger: state
  conditions: []
  actions:
  - data:
      message: להוציא
    enabled: true
    action: notify.home_assistant_telegram
  - data:
      stop_actions: true
    enabled: true
    action: automation.turn_off
    target:
      entity_id: automation.one_time_automation_alert_when_nogs_is_home
  mode: single
- id: dismiss_Alert_when_charging
  alias: Dismiss alert when charging
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.aviad_phone_is_charging
    to: 'on'
  condition: []
  action:
  - service: notify.mobile_app_aviad_phone
    data:
      message: clear_notification
      data:
        tag: aviad_low_battery
  mode: single
- id: alert_when_raining
  alias: Alert when raining
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.is_raining
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition:
  - condition: numeric_state
    entity_id: cover.switcher_runner
    above: 20
    attribute: current_position
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  action:
  - service: notify.aviad_and_noga_mobiles
    data:
      message: It's raining. Do you want to close the shutter in the living room?
      data:
        actions:
        - action: close_shutter_notification
          title: Close shutter
        - action: shutter_dismiss
          title: Dismiss
        tag: rain-alert
      title: Rain
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        tag: rain-alert
    - platform: state
      entity_id:
      - binary_sensor.is_raining
      to: 'off'
    timeout:
      hours: 1
      minutes: 0
      seconds: 0
      milliseconds: 0
    continue_on_timeout: true
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ wait.trigger and wait.trigger.event and wait.trigger.event.data
          and wait.trigger.event.data.action == ''close_shutter_notification'' }}'
      sequence:
      - service: cover.set_cover_position
        metadata: {}
        data:
          position: 19
        target:
          entity_id: cover.switcher_runner
      - service: notify.aviad_and_noga_mobiles
        data:
          message: clear_notification
          data:
            tag: rain-alert
    default:
    - service: notify.aviad_and_noga_mobiles
      data:
        message: clear_notification
        data:
          tag: rain-alert
  mode: single
- id: night_env_routine_shutter
  alias: Night environment routine - shutter
  description: ''
  triggers:
  - at: '22:30:00'
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: numeric_state
    entity_id: cover.switcher_runner
    above: 17
    attribute: current_position
  actions:
  - target:
      entity_id:
      - cover.switcher_runner
    data:
      position: 17
    action: cover.set_cover_position
  mode: single
- id: alert_sonos_roam_low_battery
  alias: Alert on low Sonos Roam battery
  description: ''
  triggers:
  - entity_id: sensor.kids_bedroom_battery
    below: 40
    trigger: numeric_state
  actions:
  - data:
      message: clear_notification
      data:
        tag: roam_low_battary
    action: notify.mobile_app_aviad_phone
  - action: notify.mobile_app_aviad_phone
    data:
      message: ' {{ entity_name }} battery has dropped to {{ battery_level }}% '
      data:
        tag: roam_low_battary
  variables:
    entity_name: '{{ states[trigger.entity_id].name }}'
    battery_level: '{{ states(trigger.entity_id) }}'
- id: hyperion_per_app
  alias: Hyperion Activation per app
  description: ''
  triggers:
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: FreeTV
    id: turn_on
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: HDMI Input
    id: turn_off
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: Netflix
    id: turn_off
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: SmartTube
    id: turn_on
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    id: turn_on
    to: VLC
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: Android TV Launcher
    id: turn_off
    for:
      hours: 0
      minutes: 0
      seconds: 15
    trigger: state
  - entity_id:
    - media_player.mitv_2
    trigger: state
    attribute: media_title
    for:
      hours: 0
      minutes: 0
      seconds: 2
    id: title
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - turn_off
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id: input_boolean.hyperion_activation
        action: input_boolean.turn_off
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - turn_on
        - condition: and
          conditions:
          - condition: trigger
            id:
            - title
          - condition: template
            value_template: '{{ state_attr(''media_player.mitv_2'', ''media_title'')
              == None }}


              '
      sequence:
      - target:
          entity_id: input_boolean.hyperion_activation
        data: {}
        action: input_boolean.turn_on
    - conditions:
      - condition: and
        conditions:
        - condition: trigger
          id:
          - title
        - condition: template
          value_template: '{{ state_attr(''media_player.mitv_2'', ''media_title'')
            != None and ''2160'' in state_attr(''media_player.mitv_2'', ''media_title'').lower()
            }}


            '
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id: input_boolean.hyperion_activation
        action: input_boolean.turn_off
      - wait_for_trigger:
        - trigger: state
          entity_id:
          - media_player.mitv_2
          attribute: media_title
        timeout:
          hours: 2
          minutes: 0
          seconds: 0
          milliseconds: 0
  mode: single
- id: alert_and_speak_day_agenda
  alias: Alert and speak day agenda
  description: ''
  triggers:
  - value_template: '{% if states(''binary_sensor.is_school_vacation'') == ''on''  or
      (is_state(''input_boolean.delay_morning_routine'' ,''on'')) %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline''))  +
      timedelta(minutes = 15) + timedelta(minutes = (states(''input_number.morning_vacation_delay'')|
      int)) }}

      {% else %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline''))  +
      timedelta(minutes = 15) }}

      {% endif %}'
    trigger: template
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  actions:
  - data: {}
    enabled: true
    action: script.set_up_sonos_group
    continue_on_error: true
  - metadata: {}
    data:
      duration:
        hours: 17
        minutes: 0
        seconds: 0
    target:
      entity_id:
      - calendar.family
    response_variable: agenda
    action: calendar.get_events
  - action: jewish_calendar.count_omer
    metadata: {}
    data:
      nusach: sfarad
      language: he
      after_sunset: false
    response_variable: omer
    enabled: true
  - variables:
      time_and_weather: "Location: Petah Tikva, Israel  \nTime: {{ as_timestamp(now())
        | timestamp_custom(\"%A %d/%m/%y %H:%M\") }} \n{% set max_temp = state_attr('sensor.ims_forecast_today',
        'maximum_temperature') %}  \nWeather: {{ state_attr('sensor.ims_forecast_today',
        'weather').value }} (max of {{ max_temp.value}}{{max_temp.unit }}, {{ states('sensor.ims_precipitation_probability')}}%
        precipitation)  \n"
      calendar_events: "Family calendar events today: {%- if agenda['calendar.family'].events
        %}\n  {%- for event in agenda['calendar.family'].events %}\n  - Summary: {{
        event.summary }}\n    Start: {% if event.start is defined %}{{ as_timestamp(event.start)
        | timestamp_custom(\"%H:%M\") }}{% else %}All Day{% endif %}\n  {%- endfor
        %}\n{%- else %}\n  - No upcoming events.\n{%- endif %} \n"
      special_day_events: "Is it school day? ->  {{ states('binary_sensor.is_school_vacation')
        == 'off' }}   \nHebrew date to mention in message: '{{states('sensor.jewish_calendar_date').split()[:2]
        | join(\" \") }}'   \n{% if states('sensor.jewish_calendar_holiday') %}   \nJewish
        Holiday: '{{states('sensor.jewish_calendar_holiday')}}'  {% endif %}  \n{%
        if  omer and 'message' in omer and omer['message'] %} Counting of the Omer:
        {{ omer['message'] }}{% endif %}  \n"
      max_res_tokens: 1000
      general_instructions: "Generate text for a notification that will be  be heard
        in our house speakers. no emojis.    **IMPORTANT: Return ONLY the  final message
        in Hebrew. Do NOT describe your reasoning, plan, or thoughts. No explanations,
        no preambles. This is a hard requirement.**  \n- You are a helpful personal
        agent that generates text for the Levy family. your answer should always be
        in Hebrew language. Family members are: Dad, Mom, Yair, Ayala. in Hebrew spelled:
        אבא, אמא, יאיר, איילה    \n- Your answers are helpful, friendly, insightful
        and kids friendly.   \n- Your message should not be longer than {{ max_res_tokens
        }} tokens! this is a hard requirement!    \n- Your answer should contain 3
        paragraphs, and 1 short goodbye paragraph.  \n"
      specific_instructions: "- Your messages help the user prepare for their day,
        for example:\n  - Making note of unusual weather for the location and time
        of year (but not mundane details like \"0% chance of precipitation\")\n  -
        Anything that may be special or unique, such as celebrating a birthday\n\n-
        Your priority so everything can be in that message is:\n  - Weather forcast,
        but ignore if temperature is 0. it means something went wrong\n  - Upcoming
        calendar events\n  - adding a joke or an insightful thing or a meaningful
        event from history\n"
      ai_request: '{{ time_and_weather }}

        {{ calendar_events }}

        {{ special_day_events }}

        {{ general_instructions }}

        {{ specific_instructions }}

        '
    alias: Define AI request
  - metadata: {}
    data:
      text: '{{ ai_request }}'
      agent_id: conversation.gemini_pro
    response_variable: agent
    action: conversation.process
  - alias: Validate AI response and retry
    if:
    - condition: template
      value_template: '{{ agent.response[''speech''][''plain''][''speech''] == "Sorry,
        I had a problem getting a response from Google Generative AI." or agent.response[''response_type'']
        == ''error'' }}'
    then:
    - metadata: {}
      data:
        text: '{{ ai_request }}'
        agent_id: conversation.gemini_flash_pro
      response_variable: agent
      action: conversation.process
    - if:
      - condition: template
        value_template: '{{ agent.response[''speech''][''plain''][''speech''] == "Sorry,
          I had a problem getting a response from Google Generative AI." or agent.response[''response_type'']
          == ''error'' }}'
      then:
      - data:
          message: Unable to get AI response
          data:
            inline_keyboard: Suggest a song:/suggest_song
        action: notify.home_assistant_telegram
      - variables:
          ai_response: 'בוקר טוב משפחת לוי! שיהיה לכם יום נעים מלא בחוויות טובות

            '
      else:
      - variables:
          ai_response: '{{ agent.response.speech.plain.speech | replace("אילה", "אַיָּלָה")
            }}'
    enabled: true
    else:
    - variables:
        ai_response: '{{ agent.response.speech.plain.speech | replace("אילה", "אַיָּלָה")
          }}'
  - data:
      data:
        inline_keyboard: Suggest a song:/suggest_song
      message: '{{ ai_response }}'
    action: notify.home_assistant_telegram
  - data:
      offset: 500
      message: '{{ ai_response }}

        '
      final_delay: 0
      tts_platform: google_translate
      language: iw
      chime_path: choir
      join_players: true
      unjoin_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
    enabled: true
  - alias: trigger AI Song Recommendation Automation
    event: suggest_a_song
    event_data: {}
    enabled: false
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.delay_morning_routine
  mode: single
- id: oref_alert_time_to_shelter_countdown
  alias: Pikud HaOref routine
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.oref_alert
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
    from: 'off'
    trigger: state
    enabled: true
  - trigger: state
    entity_id:
    - event.oref_alert
    to: alert
    attribute: event_type
    enabled: false
  actions:
  - if:
    - condition: template
      value_template: '{{ states.scene.before_alert == None }}'
    then:
    - action: scene.create
      metadata: {}
      data:
        scene_id: before_alert
        snapshot_entities:
        - light.wled_backlight_tv
        - light.entrance_bulb
        - light.wled_kitchen
        - fan.living_room_fan
        - light.mamad_small_socket_light
        - fan.mamad_fan
    enabled: true
  - data:
      title: התרעה
      message: בפתח תקווה
    action: notify.home_assistant_telegram
  - metadata: {}
    data:
      transition: 5
      kelvin: 2325
      brightness_pct: 60
    target:
      entity_id:
      - light.wled_backlight_tv
      - light.wled_kitchen
      - light.entrance_bulb
      - light.mamad_small_socket_light
    action: light.turn_on
    continue_on_error: true
  - action: fan.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - fan.living_room_fan
      - fan.mamad_fan
  - wait_for_trigger:
    - trigger: event
      event_type: oref_alert_update_event
      event_data:
        area: פתח תקווה
        title: ניתן לצאת מהמרחב המוגן
      alias: פתח תקווה - ניתן לצאת
      enabled: true
    - trigger: event
      event_type: oref_alert_update_event
      event_data:
        area: ברחבי הארץ
        title: ניתן לצאת מהמרחב המוגן
      alias: ברחבי הארץ - ניתן לצאת
      enabled: true
    - trigger: event
      event_type: oref_alert_update_event
      event_data:
        area: כל הארץ
        title: ניתן לצאת מהמרחב המוגן
      alias: כל הארץ - ניתן לצאת
      enabled: true
    - alias: פתח תקווה - האירוע הסתיים
      trigger: event
      event_type: oref_alert_update_event
      event_data:
        area: פתח תקווה
        title: ירי רקטות וטילים -  האירוע הסתיים
      enabled: true
    - alias: פתח תקווה - ניתן אך יש להישאר
      trigger: event
      event_type: oref_alert_update_event
      event_data:
        area: פתח תקווה
        title: ניתן לצאת מהמרחב המוגן אך יש להישאר בקרבתו
      enabled: true
    - trigger: state
      entity_id:
      - event.oref_alert
      to: end
      attribute: event_type
    timeout:
      hours: 1
      minutes: 0
      seconds: 0
      milliseconds: 0
  - if:
    - alias: Previous wait for not timed out
      condition: template
      value_template: '{{ wait.trigger != none }}'
    then:
    - action: light.turn_on
      metadata: {}
      data:
        rgb_color:
        - 0
        - 255
        - 0
      target:
        entity_id: light.mamad_small_socket_light
    - data:
        message: אפשר לצאת מהמה מד
        chime_path: bells
        cache: true
        announce: true
        language: iw
        tts_platform: google_translate
        end_chime_path: bells
        offset: 1000
        final_delay: 1000
        volume_level: '{{ 0.6 if now().hour < 19 and now().hour > 6 else 0.3 }}'
      action: chime_tts.say
      enabled: true
      target:
        entity_id: media_player.sonos_kids_bedroom
    - data:
        message: אפשר לצאת מהמה מד
        chime_path: bells
        cache: true
        announce: true
        language: iw
        tts_platform: google_translate
        end_chime_path: bells
        offset: 1000
        final_delay: 1000
        volume_level: 0.5
      target:
        entity_id: media_player.sonos_living_room
      action: chime_tts.say
      enabled: true
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - metadata: {}
    data:
      transition: 5
      kelvin: 2325
      brightness_pct: 60
    target:
      entity_id:
      - light.mamad_small_socket_light
    action: light.turn_on
    continue_on_error: true
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_alert
  - action: scene.delete
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_alert
  mode: restart
- id: alert_picking_yair
  alias: Alert when picking Yair
  description: ''
  trigger:
  - platform: zone
    entity_id: person.aviad
    zone: zone.school
    event: enter
  - platform: zone
    entity_id: person.noga
    zone: zone.school
    event: enter
  condition:
  - condition: template
    value_template: "{{ state_attr(trigger.entity_id,\n    'friendly_name') == states('input_select.who_picking_the_kids')
      }}"
  - condition: not
    conditions:
    - condition: state
      entity_id: todo.things_yair_took_to_school
      state: '0'
  - condition: time
    after: '11:30:00'
    before: '17:00:00'
  - condition: template
    value_template: '{{(as_timestamp(now()) - as_timestamp(state_attr(''automation.alert_when_picking_yair'',
      ''last_triggered'') | default(0)) | int > 21600 )}}'
    enabled: true
  action:
  - service: todo.get_items
    data:
      status: needs_action
    target:
      entity_id: todo.things_yair_took_to_school
    response_variable: service_result
  - service: notify.mobile_app_{{ state_attr(trigger.entity_id, 'id') }}_phone
    data:
      title: לוודא שיאיר לקח
      message: '{{ service_result[''todo.things_yair_took_to_school''][''items'']
        | map(attribute=''summary'') | join('' '') }}'
  mode: single
- id: who_pick_kids
  alias: Who's picking the kids
  description: ''
  triggers:
  - at: 08:00:00
    trigger: time
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: time
        weekday:
        - tue
        - wed
      sequence:
      - metadata: {}
        data:
          option: Noga
        target:
          entity_id: input_select.who_picking_the_kids
        action: input_select.select_option
    - conditions:
      - condition: time
        weekday:
        - sun
        - thu
        - fri
      sequence:
      - metadata: {}
        data:
          option: Aviad
        target:
          entity_id: input_select.who_picking_the_kids
        action: input_select.select_option
  mode: single
- id: shabbat_4
  alias: Shabbat 4 - rain routine
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.is_raining
    for:
      hours: 0
      minutes: 20
      seconds: 0
    to: 'on'
    id: raining
  - platform: state
    entity_id:
    - binary_sensor.is_raining
    for:
      hours: 0
      minutes: 20
      seconds: 0
    to: 'off'
    id: not_raining
  condition:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: time
    after: 07:00:00
    before: input_datetime.shabbat_lights_out
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.is_raining
        state: 'on'
      - condition: numeric_state
        entity_id: cover.switcher_runner
        above: 25
        attribute: current_position
      sequence:
      - service: cover.set_cover_position
        metadata: {}
        data:
          position: 19
        target:
          entity_id: cover.switcher_runner
      - if:
        - condition: state
          entity_id: light.living_room_lights
          state: 'off'
        then:
        - service: light.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: light.living_room_lights
    - conditions:
      - condition: state
        entity_id: binary_sensor.is_raining
        state: 'off'
      - condition: numeric_state
        entity_id: cover.switcher_runner
        attribute: current_position
        below: 25
      sequence:
      - service: cover.open_cover
        target:
          entity_id:
          - cover.switcher_runner
        data: {}
    default: []
  mode: single
- id: one_time_automation_office_md
  alias: One time automation - office motion
  description: ''
  trigger:
  - platform: time
    at: 08:00:00
    enabled: true
  condition: []
  action:
  - service: automation.turn_on
    data: {}
    target:
      entity_id:
      - automation.office_motion_detection
    enabled: true
  - service: automation.turn_off
    data:
      stop_actions: true
    enabled: true
    target:
      entity_id: automation.one_time_automation_office_motion
  mode: single
- id: alert_pending_updates
  alias: Alert when pending updates
  description: ''
  use_blueprint:
    path: mdegat01/update_notifications.yaml
    input:
      update_entities:
      - update.adaptive_lighting_update
      - update.adguard_home_update
      - update.bed_motion_sensor_firmware
      - update.bedroom_temperature_sensor_firmware
      - update.card_mod_update
      - update.chime_tts_update
      - update.door_sensor_firmware
      - update.dreame_vacuum_update
      - update.duck_dns_update
      - update.esphome_update
      - update.formula_one_card_update
      - update.hacs_update
      - update.home_assistant_core_update
      - update.home_assistant_operating_system_update
      - update.home_assistant_supervisor_update
      - update.israel_meteorological_service_sensor_update
      - update.kitchen_motion_sensor_firmware
      - update.kitchen_switch_firmware
      - update.living_room_door_large_firmware
      - update.living_room_door_small_firmware
      - update.living_room_temperature_sensor_firmware
      - update.living_room_window_large_firmware
      - update.living_room_window_small_firmware
      - update.mini_graph_card_update
      - update.mosquitto_broker_update
      - update.mushroom_update
      - update.oref_alert_update
      - update.pirate_weather_update
      - update.qbittorrent_update
      - update.smart_plug_kids_bedroom_firmware
      - update.studio_code_server_update
      - update.vertical_stack_in_card_update
      - update.washing_machine_contact_sensor_firmware
      - update.wled_backlight_tv_firmware
      - update.xiaomi_vacuum_map_card_update
      - update.average_sensor_update
      - update.israel_electric_corporation_iec_update
      - update.alexa_media_player_update
      - update.apexcharts_card_update
      - update.raspberry_pi_gpio_update
      - update.tailscale_update
      - update.advanced_ssh_web_terminal_update
      - update.bedroom_occupancy_firmware
      - update.city_mind_water_meter_update
      - update.spook_your_homie_update
      - update.firemote_card_update
      - update.file_editor_update
      - update.spotifyplus_update
      - update.wled_kitchen_firmware
      - update.balcony_bulbb_qvshkhh
      - update.bathroom_bulb_qvshkhh
      - update.closet_bulb_qvshkhh
      - update.config_template_card_update
      - update.kids_temperature_sensor_firmware
      - update.mashov_update
      - update.mini_pc_fingerbot_qvshkhh
      - update.tuya_local_update
      - update.nginx_proxy_manager_update
      - update.music_assistant_server_update
      - update.parent_bathroom_bulb_qvshkhh
      - update.plant_soil_tester_qvshkhh
      - update.npm_switches_update
      mobile_app_device: 4214920656084e3e0376f9a6c7b2eb48
      reminder_hours: ''
      only_after: 08:00:00
      only_before: '22:00:00'
      mobile_app_device_2: 4214920656084e3e0376f9a6c7b2eb48
- id: zigbee_switch_closet
  alias: Zigbee closet switch automation
  description: ''
  use_blueprint:
    path: homeassistant/sonoff_switch.yaml
    input:
      sonoff_button: 6d651c2bdf2caa74821a4fb0c684ef6f
      toggle_action:
      - service: light.toggle
        data:
          color_temp: 153
          brightness_pct: 100
        target:
          entity_id: light.closet_bulb
      on_action: []
- id: echo_volume_routine
  alias: Projector in bedroom routine
  description: ''
  triggers:
  - entity_id:
    - remote.mibox3
    id: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
    to: 'on'
    trigger: state
  - entity_id:
    - remote.mibox3
    id: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 0
    enabled: true
    to: 'off'
    from: 'on'
    trigger: state
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - 'off'
    then:
    - action: alexa_devices.send_text_command
      data:
        device_id: c34d2d172af44898c854fa792f0239e7
        text_command: Set volume to 3
    else:
    - action: alexa_devices.send_text_command
      data:
        device_id: c34d2d172af44898c854fa792f0239e7
        text_command: Set volume to max
    - target:
        entity_id: media_player.mibox
      data:
        volume_level: 0.6
      action: media_player.volume_set
    - metadata: {}
      data: {}
      target:
        entity_id:
        - light.bed_led_strip
        - light.parent_bathroom_bulb
        - light.closet_bulb
        - light.bedroom_light
      action: light.turn_off
  mode: single
- id: home_wifi_routine
  alias: Home WIFI connection routine
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.aviad_phone_wifi_connection
  condition: []
  action:
  - delay:
      hours: 0
      minutes: 0
      seconds: 15
      milliseconds: 0
  - service: notify.mobile_app_aviad_phone
    data:
      message: command_broadcast_intent
      data:
        intent_package_name: com.tailscale.ipn
        intent_action: com.tailscale.ipn.{{ "DIS" if "Levy" in states('sensor.aviad_phone_wifi_connection')  else
          ""}}CONNECT_VPN
    enabled: false
  - if:
    - condition: template
      value_template: '{{ states(''sensor.aviad_phone_wifi_connection'') in ["Levy",
        "Levy_5G", "Levy_EXT"] }}'
    then:
    - service: mqtt.publish
      metadata: {}
      data:
        topic: location/aviad_wifi
        payload: home
        retain: true
    else:
    - service: mqtt.publish
      metadata: {}
      data:
        topic: location/aviad_wifi
        payload: not_home
        retain: true
  mode: restart
- id: shabbat_1_1
  alias: Shabbat 1.1 - Kriat Shma when early shabbat
  description: ''
  triggers:
  - value_template: '{{ as_timestamp(states(''sensor.jewish_calendar_t_set_hakochavim''))|timestamp_custom(''%H:%M'',
      true) == as_timestamp(now())|timestamp_custom(''%H:%M'', true) }}'
    trigger: template
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: state
    entity_id: binary_sensor.is_early_shabbat
    state: 'on'
  - condition: not
    conditions:
    - condition: time
      weekday:
      - sat
  actions:
  - data:
      chime_path: choir
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
      message: לא לשכוח לחזור על קריאת שמע
    target:
      entity_id:
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  mode: single
- id: shabbat_1_2
  alias: Shabbat 1.2 - wake up
  description: ''
  triggers:
  - at: input_datetime.shabbat_morning_lights_on
    trigger: time
  - trigger: time
    at: '14:00:00'
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  actions:
  - repeat:
      count: 3
      sequence:
      - metadata: {}
        data: {}
        action: script.echo_say_the_time
      - delay:
          hours: 0
          minutes: 15
          seconds: 0
          milliseconds: 0
  mode: single
- id: '1716104348579'
  alias: Kids in school routine
  description: ''
  triggers:
  - at: 08:30:00
    id: 'off'
    trigger: time
  - at: '15:30:00'
    id: 'on'
    trigger: time
  - at: '12:30:00'
    id: 'on'
    trigger: time
    weekday:
    - mon
  - trigger: state
    entity_id:
    - input_select.mode
    to: Home
    id: 'on'
  conditions:
  - condition: state
    entity_id: binary_sensor.is_school_vacation
    state: 'off'
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: time
    weekday:
    - sun
    - mon
    - tue
    - wed
    - thu
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id:
        - 'on'
      - condition: time
        after: '12:00:00'
    - condition: trigger
      id:
      - 'off'
  actions:
  - target:
      entity_id: light.bathroom_bulb
    action: light.turn_{{ trigger.id }}
  - if:
    - condition: trigger
      id:
      - 'off'
    - condition: state
      entity_id: binary_sensor.is_raining
      state: 'off'
    - condition: state
      entity_id: binary_sensor.is_dst
      state: 'on'
    then:
    - metadata: {}
      data:
        position: 35
      target:
        entity_id: cover.switcher_runner
      action: cover.set_cover_position
  mode: single
- id: '1720729188404'
  alias: Alert when Samba disconnected
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.system_monitor_disk_free_media_smb
    to: unavailable
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: smb
  - trigger: state
    entity_id:
    - person.aviad
    to: home
    id: smb
  conditions:
  - condition: state
    entity_id: sensor.system_monitor_disk_free_media_smb
    state: unavailable
  actions:
  - metadata: {}
    data:
      message: Samba disk disconnected
      data:
        tag: smb-disconnected
    action: notify.mobile_app_aviad_phone
  - wait_for_trigger:
    - entity_id:
      - sensor.system_monitor_disk_free_media_smb
      trigger: state
      from: unavailable
  - data:
      message: clear_notification
      data:
        tag: smb-disconnected
    action: notify.mobile_app_aviad_phone
  mode: single
- id: '1721752734315'
  alias: Alert when Tzet Hatzom
  description: ''
  triggers:
  - entity_id:
    - sensor.jewish_calendar_holiday
    attribute: type
    from: FAST_DAY
    trigger: state
  conditions: []
  actions:
  - wait_for_trigger:
    - entity_id:
      - sensor.jewish_calendar_t_set_hakochavim
      trigger: state
    continue_on_timeout: true
    timeout:
      hours: 0
      minutes: 24
      seconds: 0
      milliseconds: 0
  - data:
      message: נגמר הצום! אפשר לאכול ולשתות! בתיאבון!
      tts_platform: google_translate
      join_players: true
      unjoin_players: true
      cache: true
      announce: true
      fade_audio: true
      language: iw
      chime_path: classical
      volume_level: 0.5
    target:
      entity_id:
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  - action: notify.send_message
    data:
      message: Tzet ha tzom
    target:
      entity_id:
      - notify.bedroom_echo_dot_announce
  - if:
    - condition: state
      entity_id: person.aviad
      state: not_home
    then:
    - metadata: {}
      data:
        message: צאת הצום
      action: notify.mobile_app_aviad_phone
  mode: single
- id: '1724096343618'
  alias: Recover qbittorrent
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.qbittorrent_status
    to: downloading
    for:
      hours: 1
      minutes: 0
      seconds: 0
  condition: []
  action:
  - action: telegram_bot.send_message
    metadata: {}
    data:
      title: Restarting qbittorrent
      message: ' '
  - action: hassio.addon_restart
    metadata: {}
    data:
      addon: db21ed7f_qbittorrent
  mode: single
- id: '1728804453243'
  alias: Tag Sofa is scanned
  description: ''
  triggers:
  - trigger: tag
    tag_id: ee249a7f-c780-4c3e-a649-1027e2c37ec7
  conditions: []
  actions:
  - action: scene.turn_on
    metadata: {}
    target:
      entity_id: scene.movie
    data: {}
  - action: button.press
    metadata: {}
    data: {}
    target:
      entity_id: button.wake_on_lan_mitv
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.wled_kitchen
  mode: single
- id: '1728804893672'
  alias: When Movie scene activated
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - scene.movie
  conditions: []
  actions:
  - action: button.press
    metadata: {}
    data: {}
    target:
      entity_id: button.wake_on_lan_mitv
  mode: single
- id: '1729492826254'
  alias: test template
  description: ''
  triggers: []
  conditions: []
  actions:
  - action: persistent_notification.create
    metadata: {}
    data:
      message: Success
    enabled: false
  - action: script.get_random_song_from_playlist
    metadata: {}
    data:
      playlist_id: 07c13wipxpcwEl7eMRJRjk
    enabled: false
  mode: single
- id: '1730829192764'
  alias: Alert when Mini PC disconnected
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.mini_pc
    to:
    - 'off'
    trigger: state
    id: minipc
    for:
      hours: 0
      minutes: 5
      seconds: 0
  - trigger: homeassistant
    event: start
  conditions: []
  actions:
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - if:
    - condition: state
      entity_id: binary_sensor.mini_pc
      state: 'off'
    then:
    - metadata: {}
      data:
        message: Mini PC disconnected
        data:
          actions:
          - action: finger_bot_toggle
            title: Turn on
          tag: mini-pc-disconnected
      action: notify.mobile_app_aviad_phone
    - wait_for_trigger:
      - event_type: mobile_app_notification_action
        event_data:
          tag: mini-pc-disconnected
        trigger: event
      - entity_id:
        - binary_sensor.mini_pc
        to: 'on'
        trigger: state
      timeout:
        hours: 1
        minutes: 0
        seconds: 0
        milliseconds: 0
    - if:
      - condition: template
        value_template: '{{ wait.trigger and wait.trigger.event and wait.trigger.event.data
          and wait.trigger.event.data.action == ''finger_bot_toggle'' }}'
      then:
      - target:
          entity_id: switch.mini_pc_fingerbot_switch
        data: {}
        action: switch.toggle
      - data:
          message: clear_notification
          data:
            tag: mini-pc-disconnected
        action: notify.mobile_app_aviad_phone
      else:
      - data:
          message: clear_notification
          data:
            tag: mini-pc-disconnected
        action: notify.mobile_app_aviad_phone
  mode: restart
- id: '1732133474783'
  alias: Kitchen WLED Music
  description: ''
  triggers:
  - entity_id:
    - media_player.sonos_kitchen
    for:
      hours: 0
      minutes: 0
      seconds: 10
    to: playing
    trigger: state
  conditions:
  - condition: state
    entity_id: switch.wled_backlight_tv_sync_send
    state: 'off'
  actions:
  - data:
      brightness_pct: 90
      effect: '{{ state_attr("light.wled_kitchen", "effect_list")[1:118] | reject("equalto",
        "RSVD") | list | random }}'
    target:
      entity_id: light.wled_kitchen
    action: light.turn_on
  - target:
      entity_id: select.wled_kitchen_color_palette
    data:
      option: '{{ state_attr(''select.wled_kitchen_color_palette'', ''options'') |
        random }}'
    action: select.select_option
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_kitchen
      from: playing
      for:
        hours: 0
        minutes: 0
        seconds: 7
      trigger: state
    timeout:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - data: {}
    target:
      entity_id: light.wled_kitchen
    action: light.turn_off
  mode: restart
- id: '1732136443914'
  alias: Kitchen WLED motion sensor
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.espresense_kitchen_occupancy
    to: 'on'
    trigger: state
    from: 'off'
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: sun.sun
    state: below_horizon
    enabled: false
  - condition: state
    entity_id: light.kitchen_switch
    state: 'off'
  actions:
  - data:
      kelvin: 6500
      brightness_pct: 50
      transition: 10
      effect: Solid
    action: light.turn_on
    target:
      entity_id: light.wled_kitchen
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.espresense_kitchen_occupancy
      from: 'on'
      to: 'off'
      for:
        hours: 0
        minutes: 2
        seconds: 0
      trigger: state
    - trigger: state
      entity_id:
      - light.kitchen_switch
      to: 'on'
    timeout:
      hours: 0
      minutes: 30
      seconds: 0
      milliseconds: 0
  - data:
      transition: 15
    action: light.turn_off
    target:
      entity_id: light.wled_kitchen
  mode: restart
- id: '1732870692023'
  alias: Kitchen WLED routine
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - light.wled_kitchen
    to: 'on'
  conditions: []
  actions:
  - action: light.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: light.wled_kitchen_main
  mode: single
- id: '1733873712830'
  alias: Alert when no free space
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.desktop_levy_storage_c_free_space
    - sensor.system_monitor_disk_free
    - sensor.system_monitor_disk_free_media_smb
    below: 30
  conditions: []
  actions:
  - action: notify.home_assistant_telegram
    metadata: {}
    data:
      message: '{{ trigger.to_state.name }} is running out of free space'
  mode: single
- id: '1736891049343'
  alias: Alert when needs to water the plant
  description: ''
  triggers:
  - trigger: time
    at: '18:00:00'
  conditions:
  - condition: time
    weekday:
    - thu
    - wed
    - tue
    - mon
    - sun
  - condition: numeric_state
    entity_id: sensor.plant_soil_tester_soil_moisture
    below: 85
  - condition: state
    entity_id: input_select.mode
    state: Home
  actions:
  - action: notify.aviad_and_noga_mobiles
    metadata: {}
    data:
      message: להשקות אותי בבקשה
      title: עציץ בסלון
  - action: chime_tts.say
    metadata: {}
    data:
      message: נא להשקות את העציץ בסלון
      tts_platform: google_translate
      join_players: true
      unjoin_players: true
      cache: true
      announce: true
      fade_audio: true
      language: iw
      chime_path: toast
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
      - media_player.sonos_kids_bedroom
  mode: single
- id: '1745581752788'
  alias: Mode changer - Shabbat alert
  description: ''
  triggers:
  - trigger: time
    at:
      entity_id: sensor.jewish_calendar_upcoming_candle_lighting
      offset: -01:30:00
    id: 'on'
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: state
    entity_id: binary_sensor.is_early_shabbat
    state: 'on'
  actions:
  - action: notify.mobile_app_aviad_phone
    metadata: {}
    data:
      message: רוטינת שבת תחל בעוד 30 דק'
      data:
        actions:
        - action: shabbat-delay
          title: Postpone Shabbat
        tag: shabbat-delay
  - wait_for_trigger:
    - event_type: mobile_app_notification_action
      event_data:
        tag: shabbat-delay
      trigger: event
    timeout:
      hours: 0
      minutes: 29
      seconds: 0
      milliseconds: 0
  - if:
    - condition: template
      value_template: '{{ wait.trigger and wait.trigger.event.data.action == ''shabbat-delay''
        }}'
    then:
    - action: input_boolean.turn_on
      metadata: {}
      data: {}
      target:
        entity_id: input_boolean.delay_shabbat
  - action: notify.mobile_app_aviad_phone
    data:
      message: clear_notification
      data:
        tag: shabbat-delay
  mode: single
- id: '1745775409890'
  alias: Pikud HaOref - pre-emptive alert
  description: ''
  triggers:
  - trigger: event
    event_type: oref_alert_update_event
    event_data:
      area: פתח תקווה
    enabled: true
  - trigger: event
    event_type: oref_alert_update_event
    event_data:
      area: כל הארץ
    enabled: true
  - trigger: event
    event_type: oref_alert_update_event
    event_data:
      area: ברחבי הארץ
    enabled: true
  - trigger: state
    entity_id:
    - event.oref_alert
    attribute: event_type
    to: pre_alert
    enabled: false
  conditions: []
  actions:
  - variables:
      title: עדכון מפיקוד העורף
      area: '{{ trigger.to_state.attributes.record[''area''] }}'
      message: '{{ trigger.to_state.attributes.record[''title''] }}'
      emoji: '{{ trigger.to_state.attributes.record[''emoji''] }}'
  - action: notify.home_assistant_telegram
    metadata: {}
    data:
      message: '{{ message }}'
      title: '{{ emoji }} {{ title }} - {{ area }}'
  - if:
    - condition: or
      conditions:
      - condition: time
        weekday:
        - sun
        - mon
        - tue
        - wed
        - thu
        - sat
        after: 07:00:00
        before: '19:30:00'
      - condition: time
        weekday:
        - fri
        before: input_datetime.shabbat_night_baseline_routine
        after: 07:00:00
    then:
    - alias: Play message on all speakers
      action: chime_tts.say
      target:
        entity_id:
        - media_player.sonos_living_room
        - media_player.sonos_kids_bedroom
        - media_player.sonos_kitchen
      data:
        chime_path: bells
        tts_platform: google_translate
        language: iw
        message: '{{ title }}: {{ message }}'
        announce: true
        volume_level: '{{ 0.6 if now().hour < 17 else 0.4 }}'
        cache: true
  - alias: If TV is on
    if:
    - condition: state
      entity_id: media_player.mitv
      state: 'on'
    then:
    - action: notify.mi_tv
      metadata: {}
      data:
        title: '{{ emoji }}{{ title }}'
        data:
          color: red
          duration: 15
          transparency: 5%
          fontsize: large
        message: '{{ message }}'
  - delay:
      hours: 0
      minutes: 0
      seconds: 15
      milliseconds: 0
  mode: single
- id: '1746014164139'
  alias: AI Song Suggestion
  description: ''
  triggers:
  - trigger: event
    event_type: suggest_a_song
    id: hass
  - trigger: event
    event_type: telegram_command
    event_data:
      command: /suggest_song
    id: telegram
  - trigger: event
    event_type: telegram_callback
    event_data:
      command: /suggest_song
    id: telegram
  - trigger: event
    event_type: telegram_command
    event_data:
      command: /suggest_playlist
    id: telegram
  conditions: []
  actions:
  - variables:
      music_type: '{% if ''command'' in trigger.event.data and trigger.event.data.command
        == ''/suggest_playlist'' %} playlist {% else %} track {% endif %}

        '
  - action: input_text.set_value
    metadata: {}
    data:
      value: ' '
    target:
      entity_id:
      - input_text.current_song_selected
      - input_text.current_song_reason
  - if:
    - condition: trigger
      id:
      - telegram
    then:
    - action: telegram_bot.send_message
      metadata: {}
      data:
        target:
        - '{{ trigger.event.data.chat_id }}'
        message: בקשתך התקבלה. מתייעץ עם AI...
        disable_notification: true
      response_variable: first_message
  - metadata: {}
    data:
      duration:
        hours: 17
        minutes: 0
        seconds: 0
    target:
      entity_id:
      - calendar.family
    response_variable: agenda
    action: calendar.get_events
  - alias: Set criteria for AI
    variables:
      song_criteria: "The {{ music_type }} should be in hebrew. it should be relevant
        for the details. the details are sorted with priority:  \n{% if states('sensor.jewish_calendar_holiday')
        %} Jewish Holiday: '{{states('sensor.jewish_calendar_holiday')}}'  {% endif
        %}\n{%- if agenda['calendar.family'].events %} Family calendar events today:
        \n  {%- for event in agenda['calendar.family'].events %}\n  - Summary: {{
        event.summary }}\n  {%- endfor %}\n{%- endif %} \n{%- if states('binary_sensor.is_school_vacation')
        == 'on' %} Is it school day? ->  {{ states('binary_sensor.is_school_vacation')
        == 'off' }} {%- endif %}\n{% set max_temp = state_attr('sensor.ims_forecast_today',
        'maximum_temperature') %} Weather:  {{ state_attr('sensor.ims_forecast_today',
        'weather').value }} (max of {{ max_temp.value}}{{max_temp.unit }}, {{ states('sensor.ims_precipitation_probability')}}%
        precipitation)  \nTime: {{ as_timestamp(now()) | timestamp_custom(\"%A %d/%m/%y
        %H:%M:%S\") }}\n"
  - alias: Set request for AI
    variables:
      request_ai: 'You will recommend me a {{ music_type }} based on criteria. you
        answer would be in format of key-value yaml style without any ''```'':   song_name:
        "<the {{ music_type }} name in hebrew>{% if music_type == ''track'' %} - <artist>{%
        endif %}"\n reason: "<the reason you chose this. give the reason in hebrew.
        reason should be no more than 50 characters>"\n   Without any other additions.
        make sure to keep the quotes! The criteria are: {{ song_criteria }}

        '
  - alias: Request AI recommendation
    data:
      text: '{{ request_ai }}

        '
      agent_id: conversation.gemini_pro
    response_variable: ai_song_response
    action: conversation.process
    enabled: true
  - alias: Validate AI response
    if:
    - condition: template
      value_template: '{{ ai_song_response.response[''speech''][''plain''][''speech'']
        == "Sorry, I had a problem getting a response from Google Generative AI."
        or ai_song_response.response[''response_type''] == ''error'' }}'
    then:
    - alias: Send error notification
      if:
      - condition: trigger
        id:
        - telegram
      then:
      - action: telegram_bot.edit_message
        metadata: {}
        data:
          message_id: '{{ first_message[''chats''][0][''message_id''] }} '
          message: '{{ai_song_response.response[''speech''][''plain''][''speech''][:20]}}'
          chat_id: '{{ trigger.event.data.chat_id }}'
      - action: telegram_bot.edit_message
        metadata: {}
        data:
          message_id: '{{ first_message[''chats''][0][''message_id''] }} '
          message: מנסה עם מודל אחר
          chat_id: '{{ trigger.event.data.chat_id }}'
      else:
      - alias: Send Android notification that error happened
        data:
          message: '{{ai_song_response.response[''speech''][''plain''][''speech'']}}'
        action: notify.mobile_app_aviad_phone
      - alias: Send Android retry notification
        data:
          message: Retrying...
        action: notify.mobile_app_aviad_phone
    - alias: Request another AI recommendation
      data:
        text: '{{ request_ai }}

          '
        agent_id: conversation.gemini_flash_pro
      response_variable: ai_song_response
      action: conversation.process
      enabled: true
    - if:
      - condition: template
        value_template: '{{ ai_song_response.response[''speech''][''plain''][''speech'']
          == "Sorry, I had a problem getting a response from Google Generative AI."
          or ai_song_response.response[''response_type''] == ''error'' }}'
      then:
      - alias: Send error notification
        if:
        - condition: trigger
          id:
          - telegram
        then:
        - action: telegram_bot.edit_message
          metadata: {}
          data:
            message_id: '{{ first_message[''chats''][0][''message_id''] }} '
            message: '{{ai_song_response.response[''speech''][''plain''][''speech'']}}'
            chat_id: '{{ trigger.event.data.chat_id }}'
        else:
        - alias: Send Android notification that error happened
          data:
            message: '{{ai_song_response.response[''speech''][''plain''][''speech'']}}'
          action: notify.mobile_app_aviad_phone
      - stop: Unable to get response from AI
    enabled: true
  - alias: Extract song name
    variables:
      ai_response: '{{ ai_song_response.response[''speech''][''plain''][''speech'']
        }}'
      song_name: '{{ ai_response | regex_findall_index(''song_name:\s*"(.*?)"'', 0)
        }}

        '
      reason: '{{ ai_response | regex_findall_index(''reason:\s*"(.*?)"'', 0) }}

        '
    enabled: true
  - alias: Search song on Spotify
    data:
      criteria: '{{ song_name }}'
      entity_id: media_player.spotifyplus_aviad
    response_variable: spotify_search_response
    action: spotifyplus.search_{{ music_type }}s
  - alias: Extract song details
    variables:
      track_data: '{{ spotify_search_response[''result''][''items''][0] }}'
      song_title: '{{ track_data[''name''] }}'
      song_uri: '{{ track_data[''uri''] }}'
      song_image: '{{ track_data[''image_url''] }}'
      artist_name: "{% if 'artists' in track_data %}\n - {{ track_data['artists'][0]['name']
        }}\n{% else %} {% endif %}\n"
      song_display: '{{ song_title }}{{ artist_name }}'
      song_external_url: '{% if ''external_urls'' in track_data and ''spotify'' in
        track_data[''external_urls''] %} {{ track_data[''external_urls''][''spotify'']
        }} {% else %} {% endif %}

        '
  - action: input_text.set_value
    metadata: {}
    data:
      value: '{{ song_uri }}'
    target:
      entity_id: input_text.current_song_selected
  - action: input_text.set_value
    metadata: {}
    data:
      value: '{{reason }}'
    target:
      entity_id: input_text.current_song_reason
  - alias: Send message
    choose:
    - conditions:
      - condition: trigger
        id:
        - hass
      sequence:
      - alias: Send Android notification with image and action
        data:
          message: '{{reason}}. תרצה להשמיע אותו?'
          title: 'המלצת שיר: {{ song_display }}'
          data:
            image: '{{ song_image }}'
            actions:
            - action: PLAY_AI_SONG
              title: Play it
        action: notify.mobile_app_aviad_phone
    - conditions:
      - condition: trigger
        id:
        - telegram
      sequence:
      - action: telegram_bot.delete_message
        metadata: {}
        data:
          message_id: '{{ first_message[''chats''][0][''message_id''] }} '
          chat_id: '{{ trigger.event.data.chat_id }}'
      - alias: Send photo of playlist
        if:
        - condition: template
          value_template: '{{ music_type == ''playlist'' }}'
        then:
        - action: telegram_bot.send_photo
          metadata: {}
          data:
            url: '{{ song_image }}'
            caption: '{{ song_display }}'
            target:
            - '{{ trigger.event.data.chat_id }}'
            disable_notification: true
          enabled: true
      - action: telegram_bot.send_message
        metadata: {}
        data:
          message: '{% if song_external_url and song_external_url != '''' %}[{{ song_display
            }}]({{ song_external_url }}){% else %}{{ song_display }}{% endif %}

            {{reason}}. תרצה להשמיע אותו?'
          target:
          - '{{ trigger.event.data.chat_id }}'
          inline_keyboard: Play it:/play_it
          disable_notification: true
  mode: restart
- id: '1746373161046'
  alias: Kitchen WLED current routine
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.wled_kitchen_estimated_current
    above: input_number.wled_current_estimation_threshold
    for:
      hours: 0
      minutes: 0
      seconds: 20
  conditions: []
  actions:
  - repeat:
      sequence:
      - variables:
          current_brightness_level: '{{ (state_attr(''light.wled_kitchen'', ''brightness'')
            / 256 * 100) | round }}'
          current_current_estimation: '{{ states(''sensor.wled_kitchen_estimated_current'')
            }}'
      - action: notify.mobile_app_aviad_phone
        metadata: {}
        data:
          title: Lowered WLED kitchen brightness
          message: 'brightness level - {{ current_brightness_level }}% -> {{ current_brightness_level
            - 5 }}%\n current estimation: {{ current_current_estimation }}'
        enabled: false
      - action: light.turn_on
        metadata: {}
        data:
          brightness_step_pct: -8
        target:
          entity_id: light.wled_kitchen
      - delay:
          hours: 0
          minutes: 1
          seconds: 0
          milliseconds: 0
      while:
      - condition: numeric_state
        entity_id: sensor.wled_kitchen_estimated_current
        above: input_number.wled_current_estimation_threshold
      - condition: numeric_state
        entity_id: light.wled_kitchen
        attribute: brightness
        above: 20
  - delay:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
  - action: notify.mobile_app_aviad_phone
    metadata: {}
    data:
      title: Done lowering WLED kitchen brightness
      message: 'Final brightness level - {{ (state_attr(''light.wled_kitchen'', ''brightness'')
        / 256 * 100) | round }}%\n current estimation: {{ current_current_estimation
        }}'
    enabled: false
  mode: single
- id: '1746558165256'
  alias: Play song from callback
  description: ''
  triggers:
  - event_type: mobile_app_notification_action
    event_data:
      action: PLAY_AI_SONG
    trigger: event
  - trigger: event
    event_type: telegram_callback
    event_data:
      command: /play_it
  conditions: []
  actions:
  - variables:
      triggered_by: '{% if trigger and trigger.event.data.from_first %} {{ trigger
        and trigger.event.data.from_first | lower }} {% else %} aviad {% endif %}

        '
  - alias: Play song
    if:
    - condition: time
      before: '19:30:00'
      after: 06:30:00
    - alias: The person triggered is home
      condition: or
      conditions:
      - alias: aviad triggered and home
        condition: and
        conditions:
        - condition: template
          value_template: '{{ triggered_by == "aviad" }}'
        - condition: state
          entity_id: person.aviad
          state: home
      - alias: noga triggered and home
        condition: and
        conditions:
        - condition: template
          value_template: '{{ triggered_by == ''noga'' }}'
        - condition: state
          entity_id: person.noga
          state: home
    then:
    - action: script.set_up_sonos_group
      metadata: {}
      data: {}
      enabled: true
    - action: chime_tts.say
      metadata: {}
      data:
        chime_path: classical
        message: '{{ states(''input_text.current_song_reason'') }}'
        tts_platform: google_translate
        join_players: true
        language: iw
        end_chime_path: drumroll
      target:
        entity_id:
        - media_player.sonos_living_room
        - media_player.sonos_kitchen
        - media_player.sonos_kids_bedroom
      enabled: true
    - action: script.set_up_sonos_group_music_casting
      data: {}
      enabled: true
    - alias: Play song on speaker
      target:
        entity_id:
        - media_player.sonos_living_room
      data:
        media_content_id: '{{ states(''input_text.current_song_selected'') }}'
        media_content_type: music
      action: media_player.play_media
      enabled: true
    else:
    - action: notify.mobile_app_{{ triggered_by }}_phone
      data:
        message: command_activity
        data:
          intent_package_name: com.spotify.music
          intent_action: com.spotify.mobile.android.ui.action.player.SHOW
          intent_class_name: com.spotify.music.MainActivity
    - delay:
        hours: 0
        minutes: 0
        seconds: 1
        milliseconds: 0
    - action: notify.mobile_app_{{ triggered_by }}_phone
      data:
        message: command_activity
        data:
          intent_package_name: com.spotify.music
          intent_action: android.intent.action.VIEW
          intent_uri: '{{ states(''input_text.current_song_selected'') }}:play'
    enabled: true
  mode: single
- id: '1747345676292'
  alias: Reset override school vacation
  description: ''
  triggers:
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: state
    entity_id: input_boolean.override_is_school_vacation
    state: 'on'
  actions:
  - action: notify.mobile_app_aviad_phone
    metadata: {}
    data:
      message: Turn off override is school vacation?
      data:
        actions:
        - action: turn_off
          title: 'Yes'
        - action: dismiss
          title: 'No'
        tag: override-school-alert
  - wait_for_trigger:
    - event_type: mobile_app_notification_action
      event_data:
        tag: override-school-alert
      trigger: event
    timeout:
      hours: 1
      minutes: 0
      seconds: 0
      milliseconds: 0
    continue_on_timeout: true
  - if:
    - condition: template
      value_template: '{{ wait.trigger and wait.trigger.event and wait.trigger.event.data
        and wait.trigger.event.data.action == ''dismiss'' }}'
    then:
    - data:
        message: clear_notification
        data:
          tag: override-school-alert
      action: notify.mobile_app_aviad_phone
    else:
    - action: input_boolean.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: input_boolean.override_is_school_vacation
  mode: single
- id: '1751918356816'
  alias: Alert when vacation mode made a call
  description: ''
  triggers:
  - trigger: event
    event_type: presence_simulation_change
  conditions: []
  actions:
  - action: notify.home_assistant_direct_telegram
    metadata: {}
    data:
      message: 'Simulation of the entity {{ trigger.event.data.entity_id }}, {{trigger.event.data.service
        }} called with following parameters: {{trigger.event.data.service_data }}'
  mode: single
- id: '1751918477065'
  alias: Vacation routine
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_select.mode
    to: Away
    for:
      hours: 48
      minutes: 0
      seconds: 0
    id: 'On'
  - trigger: state
    entity_id:
    - input_select.mode
    to: Home
    id: 'Off'
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - 'On'
    then:
    - if:
      - condition: time
        before: 08:00:00
      then:
      - wait_for_trigger:
        - trigger: time
          at: 08:00:00
        timeout:
          hours: 8
          minutes: 0
          seconds: 0
          milliseconds: 0
      alias: Wait till 8am
    - action: notify.home_assistant_direct_telegram
      metadata: {}
      data:
        message: You should consider turning vacation mode on
        title: 'You''re away for at least 48 hours. '
    else:
    - action: switch.turn_off
      metadata: {}
      data: {}
      target:
        entity_id: switch.simulation
  mode: single
- id: '1753893801326'
  alias: Mamad light motion detection
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.mamad_small_socket_light_tnv_h
    to: 'on'
    trigger: state
    from: 'off'
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  actions:
  - data:
      kelvin: 6500
      brightness_pct: 50
      transition: 10
      effect: Solid
    action: light.turn_on
    target:
      entity_id: light.mamad_small_socket_light
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.mamad_small_socket_light_tnv_h
      from: 'on'
      to: 'off'
      for:
        hours: 0
        minutes: 2
        seconds: 0
      trigger: state
    timeout:
      hours: 0
      minutes: 30
      seconds: 0
      milliseconds: 0
  - data:
      transition: 15
    action: light.turn_off
    target:
      entity_id: light.mamad_small_socket_light
  mode: restart
- id: '1757437919222'
  alias: Turn off fans when autumn
  description: ''
  triggers:
  - trigger: time
    at: 03:30:00
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: template
    value_template: '{{ now().month >= 9 }}'
  actions:
  - action: fan.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - fan.bedroom_fan
      - fan.kids_fan
  mode: single
- id: '1758552160635'
  alias: טעינת טלפון אוטומטית
  description: מדליק/מכבה מטען לפי אחוזי סוללה
  triggers: []
  conditions: []
  actions:
  - target:
      entity_id: switch.nexus_charger
    action: switch.turn_{{ trigger.id }}
  mode: single
- id: '1760987889728'
  alias: Mashov – Bag Reminder
  description: Runs daily at 17:00 (for tomorrow) and Fridays at 12:00 (for Sunday),
    but not on Saturday.
  triggers:
  - at: '17:00:00'
    trigger: time
    weekday:
    - sun
    - tue
    - wed
    - thu
  - at: '13:05:00'
    trigger: time
    weekday:
    - mon
  - at: '12:00:00'
    id: friday_run
    trigger: time
    weekday:
    - fri
  conditions: []
  actions:
  - variables:
      speech_text: "\n{# HA weekday: 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri, 5=Sat, 6=Sun
        #} {% set current_weekday_ha = now().weekday() %}\n{# \n  Conditional Offset:\n
        \ - If it's Friday (4), offset by 2 days (to Sunday, HA 6).\n  - Otherwise,
        offset by 1 day (to the next day).\n#} {% set days_offset = \n  2 if current_weekday_ha
        == 4 \n  else 1 \n%}\n{# Calculate the target weekday in HA format (0=Mon
        to 6=Sun) #} {% set target_weekday_ha = (current_weekday_ha + days_offset)
        % 7 %} \n{# \n  Convert HA weekday (0=Mon to 6=Sun) to Mashov Day (1=Sun to
        7=Sat).\n#} {% set target_day_mashov = ((target_weekday_ha + 1) % 7) + 1 %}\n{#
        START OF ORIGINAL LESSON PROCESSING LOGIC #} {% set lessons = state_attr('sensor.mashov_yyr_lvy_g4_timetable',
        'items') %}\n{% set lessons_for_day = lessons\n  | selectattr('timeTable.day',
        'eq', target_day_mashov)\n  | sort(attribute='timeTable.lesson')\n  | list\n%}\n{%
        if lessons_for_day | count > 0 %}\n  {# Initialize namespace for building
        the final list and tracking subject counts #}\n  {% set ns = namespace(\n
        \   final_subjects=[],\n    subject_counts={}\n  ) %}\n  \n  {# 1. Iterate
        through the lessons, apply replacements, and ensure uniqueness #}\n  {% for
        lesson in lessons_for_day %}\n    {% set subject = lesson.groupDetails.subjectName
        %}\n    {% set current_subject = subject %}\n    \n    {# Increment the counter
        for this subject name #}\n    {% set count = ns.subject_counts.get(current_subject,
        0) + 1 %}\n    {% set ns.subject_counts = dict(ns.subject_counts, **{current_subject:
        count}) %}\n    \n    {# === Replacement Logic for Mashov Day 2 (Monday) ===
        #}\n    {% if target_day_mashov == 2 %}\n      \n      {# Replace מתמטיקה
        with גיאומטריה #}\n      {% if current_subject == 'מתמטיקה' %}\n        {%
        set current_subject = 'גיאומטריה' %}\n      {% endif %}\n    {% endif %}\n\n
        \   \n    {# 2. Check if the (potentially modified) subject is already in
        the final list #}\n    {% if current_subject not in ns.final_subjects %}\n
        \     {% set ns.final_subjects = ns.final_subjects + [current_subject] %}\n
        \   {% else %}\n      {# \n        CRUCIAL EXCEPTION: If the original name
        (subject) was modified and the \n        new name (current_subject) is already
        there, check if the modification \n        was the 'second מדעים -> הלכה'
        change. If so, and the original 'מדעים' is \n        already in the list,
        we must include the new name.\n      #}\n      {% if target_day_mashov ==
        3 and subject == 'מדעים' and current_subject == 'הלכה' %}\n        {# We only
        add it if 'מדעים' (the first one) is already in the list #}\n        {% if
        'מדעים' in ns.final_subjects %}\n          {% set ns.final_subjects = ns.final_subjects
        + [current_subject] %}\n        {% endif %}\n      {% endif %}\n    {% endif
        %}\n    \n  {% endfor %}\n  \n  {# 3. Output the final comma-separated list
        with contextual message #}\n  {% if current_weekday_ha == 4 %}\n    היום יום
        שישי, **מערכת** השיעורים ליום **ראשון** היא: {{ ns.final_subjects | join(',
        ') }}\n  {% else %}\n    **מערכת** השיעורים ל**מחר** היא: {{ ns.final_subjects
        | join(', ') }}\n  {% endif %}\n  \n{% else %}\n  {% if current_weekday_ha
        == 4 %}\n    אין שיעורים ליום ראשון. שבת שלום!\n  {% else %}\n    אין שיעורים
        למחר. תהנה מההפסקה!\n  {% endif %}\n{% endif %}"
  - action: notify.home_assistant_telegram
    data:
      message: '{{ speech_text }}'
  mode: single
- id: '1761075745328'
  alias: One time automation - re-enable automation
  description: ''
  triggers:
  - trigger: time
    at: 07:00:00
  conditions: []
  actions:
  - action: automation.turn_on
    target:
      entity_id: automation.kitchen_wled_motion_sensor
    data: {}
  - data:
      stop_actions: true
    enabled: true
    action: automation.turn_off
    target:
      entity_id: automation.one_time_automation_re_enable_automation
  mode: single
- id: '1761214598805'
  alias: Alert when needs to take medication
  description: ''
  triggers:
  - trigger: time
    at: 07:05:00
  - trigger: time
    at: '18:30:00'
  conditions: []
  actions:
  - action: notify.home_assistant_telegram
    metadata: {}
    data:
      message: תרופה לאילה
  - if:
    - condition: template
      value_template: '{{ now().date() >= as_datetime(''2025-11-02'').date() }}

        '
    then:
    - action: automation.turn_off
      metadata: {}
      data:
        stop_actions: true
      target:
        entity_id: automation.medication_alert
  mode: single
- id: '1761224536536'
  alias: Parking Reminder Notification
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - number.distance_from_car
  conditions:
  - condition: template
    value_template: "{% set device = states('input_text.park_device_tracker') %} {%
      if device != '' %}\n  {% set threshold = 2 %}\n  {% if float(states('number.distance_from_car'))
      > threshold %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% else %}\n
      \ false\n{% endif %}\n"
  actions:
  - action: telegram_bot.send_message
    metadata: {}
    data:
      title: "You left your parking spot \U0001F697"
      message: Looks like you moved away – don’t forget to stop Pango!
      config_entry_id: 01JZ6526B5R80Y7SC1WM9QM3FC
      target:
      - '-4738468398'
  - target:
      entity_id: automation.pango_reminder_notification
    action: automation.turn_off
  mode: single
- id: '1761241849332'
  alias: Parking Save Location
  description: Triggers on manual button press or Android Auto disconnect.
  triggers:
  - entity_id: input_button.park_location_lock
    trigger: state
  - entity_id:
    - binary_sensor.aviad_phone_android_auto
    - binary_sensor.noga_phone_android_auto
    to:
    - 'off'
    from:
    - 'on'
    trigger: state
    for:
      hours: 0
      minutes: 0
      seconds: 10
  actions:
  - action: notify.mobile_app_aviad_phone
    metadata: {}
    data:
      message: request_location_update
  - action: notify.mobile_app_noga_phone
    metadata: {}
    data:
      message: request_location_update
  - alias: Wait for update of Aviad location
    wait_for_trigger:
    - entity_id: device_tracker.aviad_phone
      attribute: latitude
      trigger: state
    - entity_id: device_tracker.aviad_phone
      attribute: longitude
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 20
      milliseconds: 0
    continue_on_timeout: true
  - alias: 'Wait for update of Noga location '
    wait_for_trigger:
    - entity_id: device_tracker.noga_phone
      attribute: latitude
      trigger: state
    - entity_id: device_tracker.noga_phone
      attribute: longitude
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 20
      milliseconds: 0
    continue_on_timeout: true
  - variables:
      user_device_map:
        a2963baf7a2144fd8d49218d81151b00:
          display_name: Aviad
          device_tracker: device_tracker.aviad_phone
          notify: notify.mobile_app_aviad_phone
          aa_sensor: binary_sensor.aviad_phone_android_auto
        19858e5eabec4b5182389250f3a84964:
          display_name: Noga
          device_tracker: device_tracker.noga_phone
          notify: notify.mobile_app_noga_phone
          aa_sensor: binary_sensor.noga_phone_android_auto
      pressed_user: "{% set user_from_context = trigger.to_state.context.user_id if
        trigger is defined and trigger.to_state is not none and trigger.platform ==
        'state' else none %}\n{% if user_from_context in user_device_map %}\n  {{
        user_from_context }}\n{% else %}\n  {% set triggering_sensor = trigger.entity_id
        %}\n  {% for user_id, data in user_device_map.items() %}\n    {% if data.aa_sensor
        is defined and data.aa_sensor == triggering_sensor %}\n      {{ user_id }}\n
        \   {% endif %}\n  {% endfor %}\n{% endif %}"
      display_name: '{{ user_device_map[pressed_user].display_name if pressed_user
        in user_device_map else '''' }}'
      device_tracker: '{{ user_device_map[pressed_user].device_tracker if pressed_user
        in user_device_map else '''' }}'
      notify_service: '{{ user_device_map[pressed_user].notify if pressed_user in
        user_device_map else ''notify.mobile_app_aviad_phone'' }}'
      lat: '{{ state_attr(device_tracker, ''latitude'') if device_tracker else ''''
        }}'
      lon: '{{ state_attr(device_tracker, ''longitude'') if device_tracker else ''''
        }}'
  - condition: template
    value_template: '{{ device_tracker != '''' and lat != '''' and lon != '''' }}'
  - data:
      entity_id: input_number.park_lat
      value: '{{ lat }}'
    action: input_number.set_value
  - data:
      entity_id: input_number.park_lon
      value: '{{ lon }}'
    action: input_number.set_value
  - data:
      entity_id: input_text.park_user_id
      value: '{{ pressed_user }}'
    action: input_text.set_value
  - data:
      entity_id: input_text.park_device_tracker
      value: '{{ device_tracker }}'
    action: input_text.set_value
  - action: template.reload
    metadata: {}
    data: {}
  - if:
    - condition: numeric_state
      entity_id: number.distance_from_car_to_home
      below: 0.4
    then:
    - metadata: {}
      data:
        config_entry_id: 01JZ6526B5R80Y7SC1WM9QM3FC
        target:
        - '-4738468398'
        message: You parked at home\. No reminder needed
        parse_mode: markdownv2
        title: Hi {{ display_name }}
      action: telegram_bot.send_message
    else:
    - metadata: {}
      data:
        config_entry_id: 01JZ6526B5R80Y7SC1WM9QM3FC
        target:
        - '-4738468398'
        message: You parked here
        parse_mode: markdownv2
        title: Hi {{ display_name }}
      action: telegram_bot.send_message
    - metadata: {}
      data:
        latitude: '{{ lat }}'
        longitude: '{{ lon }}'
        config_entry_id: 01JZ6526B5R80Y7SC1WM9QM3FC
        target:
        - '-4738468398'
      action: telegram_bot.send_location
    - metadata: {}
      data: {}
      target:
        entity_id: automation.pango_reminder_notification
      action: automation.turn_on
- id: '1762417373577'
  alias: 'Alert when qbittorent failures '
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.qbittorrent_errored_torrents
    above: 0
  conditions: []
  actions:
  - action: telegram_bot.send_message
    metadata: {}
    data:
      message: 'Qbittorrent has failures '
      target:
      - '191085358'
    response_variable: response
  - wait_for_trigger:
    - trigger: numeric_state
      entity_id:
      - sensor.qbittorrent_errored_torrents
      below: 1
    enabled: true
  - action: telegram_bot.delete_message
    metadata: {}
    data:
      message_id: '{{ response.chats[0].message_id }}'
      chat_id: '{{ response.chats[0].chat_id }}'
  mode: single
- &id001
  id: '1668943200000'
  alias: Daily Fan Cycle with Self-Disable
  description: Turns fan on at 10:00 and off at 16:00, then disables itself.
  triggers:
  - at: '10:00:00'
    id: turn_on
    trigger: time
  - at: '16:00:00'
    id: turn_off_and_disable
    trigger: time
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: turn_on
      sequence:
      - data: {}
        target:
          entity_id: fan.living_room_fan
        action: fan.turn_on
    - conditions:
      - condition: trigger
        id: turn_off_and_disable
      sequence:
      - condition: state
        entity_id: fan.living_room_fan
        state: 'on'
      - data: {}
        target:
          entity_id: fan.living_room_fan
        action: fan.turn_off
      - data:
          stop_actions: false
        target:
          entity_id: automation.daily_fan_cycle_with_self_disable
        action: automation.turn_off
  mode: single
- *id001
- id: '1763734617480'
  alias: One time automation - turn off
  description: ''
  triggers:
  - trigger: time
    at: '20:00:00'
  conditions: []
  actions:
  - action: fan.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: fan.living_room_fan
  - data:
      stop_actions: true
    enabled: true
    action: automation.turn_off
    target:
      entity_id: automation.one_time_automation_turn_off
  mode: single
- id: '1764332587641'
  alias: Shabbat 0 - shabbat entrance routine
  description: On mode change to shabbat mode, activate the scene and notify
  triggers:
  - entity_id: input_select.mode
    to: Shabbat
    trigger: state
  conditions: []
  actions:
  - alias: Set Shabbat/Holiday Variable
    variables:
      shabbat: '{% if states(''sensor.jewish_calendar_holiday'') == ''עיוה"כ'' %}
        יום הכיפורים {% elif states(''sensor.jewish_calendar_holiday'') == "הושענא
        רבה" %}  שמחת תורה {% elif state_attr(''sensor.jewish_calendar_holiday'',
        ''type'') == ''EREV_YOM_TOV'' %} {{ states(''sensor.jewish_calendar_holiday'')
        | replace(''ערב '', '''') }} {% else %} שבת {% endif %}

        '
  - alias: Notify Mode Change
    data:
      message: רוטינות {{ shabbat }} החלה
      data:
        tag: shabbat-mode
    action: notify.mobile_app_aviad_phone
    enabled: true
  - alias: Stop Music Assistant Addon
    metadata: {}
    data:
      addon: d5369777_music_assistant
    action: hassio.addon_stop
    enabled: true
  - alias: Activate Sunset Scene
    data: {}
    target:
      entity_id: scene.shabbat_0_sunset
    enabled: true
    action: scene.turn_on
  - alias: Turn Off TV Media Players
    data: {}
    target:
      entity_id:
      - media_player.mitv
      - media_player.mitv_adb
    enabled: true
    action: media_player.turn_off
  - alias: Set Up Sonos Speaker Group
    data: {}
    action: script.set_up_sonos_group
    enabled: true
  - alias: Define AI Request for Shabbat/Holiday Announcement
    variables:
      guest_status: '{{ ''יש'' if states(''input_boolean.guests_shabbat_dinner'')
        == ''on'' else ''אין'' }}'
      havdalah_time: '{% set dt = states(''sensor.jewish_calendar_upcoming_havdalah'')
        | as_datetime | as_local %} {% set hour_12 = dt.strftime(''%I'') | int %}
        {% set minute = dt.minute %} {{ hour_12 }}{% if minute > 0 %} ו{{ minute }}
        דקות{% endif %}

        '
      parsha_name: '{{ states("sensor.jewish_calendar_parshat_hashavua") }}'
      general_instructions: 'Generate text for a notification that will be heard on
        our house speakers. no emojis. **IMPORTANT: Return ONLY the final message
        in Hebrew. Do NOT describe your reasoning, plan, or thoughts. No explanations,
        no preambles. This is a hard requirement.**

        - You are a helpful personal agent that generates text for the Levy family.
        your answer should always be in Hebrew language. Family members are: Dad,
        Mom, Yair, Ayala. in Hebrew spelled: אבא, אמא, יאיר, איילה

        - Your answers are helpful, friendly, and insightful.

        - Your message should not be longer than 500 tokens! this is a hard requirement!

        - Your message should be one cohesive, warm, and meaningful announcement.

        '
      specific_instructions: '- The message is an announcement for the entrance of
        {{ shabbat }}.

        - Mention the current Jewish Holiday/Shabbat name: {{ shabbat }}.

        - If it is Shabbat (not a holiday), mention the Parshat HaShavua: ''{{ parsha_name
        }}''. If the parsha is ''none'', mention the holiday name instead.

        - If the current entry is Shabbat ({{ shabbat }} == ''שבת'') AND the parsha
        name is not ''none'', please add a very short summary (up to 3 sentences)
        of what the Parasha is about.

        - Announce the Havdalah time for when {{ shabbat }} ends: צאת השבת בשעה {{
        havdalah_time }}.

        - Remind the family about guests: ב{{ shabbat }} {{ guest_status }} אורחים.

        - Include a reminder to manually turn off the **refrigerator light** before
        {{ shabbat }} begins.

        - Add a short, meaningful quote or thought related to {{ shabbat }}.

        '
      ai_request: '{{ general_instructions }}

        {{ specific_instructions }}

        '
  - alias: Process AI Request (Gemini Pro)
    metadata: {}
    data:
      text: '{{ ai_request }}'
      agent_id: conversation.gemini_pro
    response_variable: agent
    action: conversation.process
  - alias: Validate AI response and retry (Gemini Flash Pro)
    if:
    - condition: template
      value_template: '{{ agent.response[''speech''][''plain''][''speech''] == "Sorry,
        I had a problem getting a response from Google Generative AI." or agent.response[''response_type'']
        == ''error'' }}'
    then:
    - metadata: {}
      data:
        text: '{{ ai_request }}'
        agent_id: conversation.gemini_flash_pro
      response_variable: agent
      action: conversation.process
    - if:
      - condition: template
        value_template: '{{ agent.response[''speech''][''plain''][''speech''] == "Sorry,
          I had a problem getting a response from Google Generative AI." or agent.response[''response_type'']
          == ''error'' }}'
      then:
      - variables:
          ai_response: '{{ shabbat }} נכנסת! נא לכבות את האור במקרר! צאת {{ shabbat
            }} ב{{ havdalah_time }}.

            '
      else:
      - variables:
          ai_response: '{{ agent.response.speech.plain.speech | replace("אילה", "אַיָּלָה")
            }}'
    else:
    - variables:
        ai_response: '{{ agent.response.speech.plain.speech | replace("אילה", "אַיָּלָה")
          }}'
  - action: notify.home_assistant_telegram
    metadata: {}
    data:
      message: '{{ ai_response }}'
    alias: Send summary to telegram
  - alias: Announce Shabbat/Holiday Entrance (AI Generated)
    action: chime_tts.say
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
      - media_player.bedroom_echo_dot
    data:
      chime_path: choir
      message: '{{ ai_response }}

        '
      tts_platform: google_translate
      language: iw
      join_players: true
      end_chime_path: tada
  - alias: Delay for Media
    delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  - alias: Wait for Sonos Pause (Start of Playback)
    wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: paused
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - alias: Set Up Sonos Group for Music Casting
    action: script.set_up_sonos_group_music_casting
    metadata: {}
    data: {}
  - alias: Select Music for Shabbat or Holiday - Play 2 songs
    if:
    - condition: template
      value_template: '{{ shabbat == ''שבת'' }}'
    then:
    - alias: Get Random Song 1 for Shabbat
      action: script.get_random_song_from_playlist
      metadata: {}
      data:
        playlist_id: 07c13wipxpcwEl7eMRJRjk
    - alias: Wait for Shabbat Song 1 to finish
      wait_for_trigger:
      - entity_id:
        - media_player.sonos_living_room
        trigger: state
        from: playing
      timeout:
        hours: 0
        minutes: 8
        seconds: 0
        milliseconds: 0
    - alias: Get Random Song 2 for Shabbat
      action: script.get_random_song_from_playlist
      metadata: {}
      data:
        playlist_id: 07c13wipxpcwEl7eMRJRjk
    else:
    - alias: Search for Holiday Song 1
      action: spotifyplus.search_tracks
      metadata: {}
      data:
        entity_id: media_player.spotifyplus_aviad
        criteria: '{{ shabbat }} חסידי'
        limit: 1
      response_variable: song1
    - alias: Play Holiday Song 1 on Speaker
      target:
        entity_id:
        - media_player.sonos_living_room
      data:
        media:
          media_content_id: '{{ song1[''result''][''items''][0][''uri''] }}'
          media_content_type: music
          metadata: {}
      action: media_player.play_media
      enabled: true
    - alias: Wait for Holiday Song 1 to finish
      wait_for_trigger:
      - entity_id:
        - media_player.sonos_living_room
        trigger: state
        from: playing
      timeout:
        hours: 0
        minutes: 8
        seconds: 0
        milliseconds: 0
    - alias: Search for Holiday Song 2
      action: spotifyplus.search_tracks
      metadata: {}
      data:
        entity_id: media_player.spotifyplus_aviad
        criteria: '{{ shabbat }} לילדים'
        limit: 1
      response_variable: song2
    - alias: Play Holiday Song 2 on Speaker
      target:
        entity_id:
        - media_player.sonos_living_room
      data:
        media:
          media_content_id: '{{ song2[''result''][''items''][0][''uri''] }}'
          media_content_type: music
          metadata: {}
      action: media_player.play_media
      enabled: true
  - alias: Wait for Sonos to Stop Playing
    wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      trigger: state
      from: playing
  - alias: Reset Sonos Speaker Group
    data: {}
    action: script.set_up_sonos_group
    enabled: true
- id: '1764711598862'
  alias: Clean carpet sentence
  description: ''
  triggers:
  - trigger: conversation
    command: נקה את השטיח
  conditions: []
  actions:
  - action: script.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: script.clean_carpet
  mode: single
- id: '1767351538479'
  alias: Telegram Parasha Image Generator
  description: ''
  triggers:
  - event_type: telegram_command
    event_data:
      command: /parasha
    trigger: event
  actions:
  - action: ai_task.generate_image
    data:
      instructions: 'An epic, detailed artistic illustration of the main story from
        the  Torah portion of {{ states(''sensor.jewish_calendar_parshat_hashavua'')
        }}.

        '
      task_name: Parasha Image Generator
      entity_id: ai_task.google_ai_task
    response_variable: generated_art
  - action: telegram_bot.send_photo
    metadata: {}
    data:
      verify_ssl: true
      config_entry_id: 01JZ6526B5R80Y7SC1WM9QM3FC
      url: '{{ generated_art.url }}'
      caption: 'Weekly Parasha: {{ states(''sensor.jewish_calendar_parshat_hashavua'')
        }}'
      target:
      - '{{ trigger.event.data.chat_id }}'
- id: '1768557711592'
  alias: Mashov - homework, grades and behaviour
  description: ''
  triggers:
  - alias: Daily schedule - Sun -> Thu
    at: '16:30:00'
    trigger: time
    weekday:
    - sun
    - mon
    - tue
    - wed
    - thu
  - alias: Daily schedule - Fri
    at: '12:00:00'
    trigger: time
    weekday:
    - fri
  conditions:
  - condition: state
    entity_id: calendar.mashov_holidays_calendar
    state:
    - 'off'
  actions:
  - if:
    - alias: Has data today?
      condition: template
      value_template: '{{ has_data_today }}'
    then:
    - action: notify.home_assistant_telegram
      metadata: {}
      data:
        message: '{{ announcement_text }}

          '
    else:
    - action: notify.home_assistant_telegram
      metadata: {}
      data:
        message: לא דווחו שיעורי בית במשוב היום ל {{ student_name }}
  mode: restart
  variables:
    homework_sensor: sensor.mashov_yyr_lvy_g4_homework
    behavior_sensor: sensor.mashov_yyr_lvy_g4_behavior
    media_player: media_player.sonos_living_room
    max_volume: 1
    tts_language: iw
    tts_start_timeout: 10
    tts_finish_timeout: 120
    blueprint_version: mashov_daily_homework_announce v1.0.6 (2025-10-18)
    allow_start: 07:00:00
    allow_end: '22:00:00'
    now_time: '{{ now().time() }}'
    student_name: "{{ state_attr(behavior_sensor,'Student name')\n   or state_attr(homework_sensor,'Student
      name')\n   or state_attr(behavior_sensor,'student_name')\n   or state_attr(homework_sensor,'student_name')\n
      \  or 'התלמיד/ה' }}\n"
    todays_homework: "{% set items = state_attr(homework_sensor,'Items') or state_attr(homework_sensor,'items')
      or [] %} {% set today = now().date() %} {% set ns = namespace(lines=[]) %} {%
      for it in items %}\n  {% if it.lesson_date is defined and it.lesson_date %}\n
      \   {% if as_datetime(it.lesson_date).date() == today %}\n      {% set subj
      = it.subject_name or it.subject or 'מקצוע' %}\n      {% set hw = (it.homework
      or it.remark or '') | replace('\\n',' ') %}\n      {% set ns.lines = ns.lines
      + [subj ~ ': ' ~ hw] %}\n    {% endif %}\n  {% endif %}\n{% endfor %} {{ ns.lines
      | join(' ; ') }}\n"
    todays_behavior: "{% set items = state_attr(behavior_sensor,'Items') or state_attr(behavior_sensor,'items')
      or [] %} {% set today = now().date() %} {% set ns = namespace(lines=[]) %} {%
      for it in items %}\n  {% if it.lesson_date is defined and it.lesson_date %}\n
      \   {% if as_datetime(it.lesson_date).date() == today %}\n      {% set subj
      = it.subject or 'מקצוע' %}\n      {% set tag  = it.achva_name or it.event or
      'אירוע' %}\n      {% set ns.lines = ns.lines + [subj ~ ': ' ~ tag] %}\n    {%
      endif %}\n  {% endif %}\n{% endfor %} {{ ns.lines | join(' ; ') }}\n"
    todays_grades: "{% set items = state_attr('sensor.mashov_yyr_lvy_g4_grades','Items')
      or state_attr('sensor.mashov_yyr_lvy_g4_grades','items') or [] %} {% set today
      = now().date() %} {% set ns = namespace(lines=[]) %}\n{% for it in items %}\n
      \ {% if it.eventDate is defined and it.eventDate %}\n    {% if as_datetime(it.eventDate).date()
      == today %}\n      {% set subj = it.subjectName or it.subject or 'מקצוע' %}\n
      \     {% set entry = \"{} ב{} ({}) - {}\".format(it.gradeType, subj, it.gradingEvent,
      it.rangeGrade) %}\n      {% set ns.lines = ns.lines + [entry] %}\n    {% endif
      %}\n  {% endif %}\n{% endfor %} {{ ns.lines | join(' ; ') }}\n"
    has_data_today: '{{ (todays_homework | trim | length > 0) or (todays_behavior
      | trim | length > 0) or (todays_grades | trim | length > 0) }}

      '
    announcement_text: "{% set ns = namespace(parts=['שלום ' ~ student_name]) %} {%
      if todays_behavior | trim | length > 0 %}\n  {% set ns.parts = ns.parts + ['התנהגות
      היום: ' ~ todays_behavior] %}\n{% endif %} {% if todays_homework | trim | length
      > 0 %}\n  {% set ns.parts = ns.parts + ['שיעורי בית היום: ' ~ todays_homework]
      %}\n{% endif %} {% if todays_grades | trim | length > 0 %}\n  {% set ns.parts
      = ns.parts + ['ציונים: ' ~ todays_grades] %}\n{% endif %} {{ ns.parts | join('.
      ') }}\n"
- id: '1769771627307'
  alias: Shabbat 1.3 - Alert when Ezra time
  description: ''
  triggers:
  - at:
      entity_id: input_datetime.ezra_isufim
      offset: -00:10:00
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: time
    weekday:
    - sat
  actions:
  - data:
      chime_path: ba_dum_tss
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
      message: בעוד עשר דקות יהיו איסופים לעזרא
      volume_level: 0.75
    target:
      entity_id:
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  - action: automation.turn_off
    metadata: {}
    target:
      entity_id: automation.shabbat_1_3_alert_when_ezra_time
    data:
      stop_actions: true
  mode: single
