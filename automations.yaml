- id: night_environment_routine
  alias: Night environment routine
  description: ''
  triggers:
  - at: '18:30:00'
    id: 'on'
    trigger: time
  - id: 'off'
    value_template: '{% if states(''binary_sensor.is_school_vacation'') == ''on''
      %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline'')) +
      timedelta(minutes = (states(''input_number.morning_vacation_delay'')| int))
      }}

      {% elif states(''input_select.mode'') == ''Shabbat'' %}

      {{ now() >= today_at(states(''input_datetime.shabbat_morning_lights_on'')) -
      timedelta(minutes = 30) }}

      {% else %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline'')) }}

      {% endif %}'
    trigger: template
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Away
  actions:
  - if:
    - condition: trigger
      id:
      - 'on'
    then:
    - data: {}
      target:
        entity_id: switch.smart_plug_kids_bedroom
      action: switch.turn_on
    - action: number.set_value
      metadata: {}
      data:
        value: '10'
      target:
        entity_id: number.dreame_robot_vacuum_d9_volume
    - action: select.select_option
      metadata: {}
      data:
        option: quiet
      target:
        entity_id: select.dreame_robot_vacuum_d9_suction_level
    else:
    - data: {}
      target:
        entity_id: switch.smart_plug_kids_bedroom
      action: switch.turn_off
    - data: {}
      target:
        entity_id:
        - fan.kids_fan
        - fan.living_room_fan
      enabled: true
      action: fan.turn_off
    - data: {}
      target:
        entity_id: light.wled_backlight_tv
      action: light.turn_off
    - if:
      - condition: or
        conditions:
        - condition: state
          entity_id: binary_sensor.is_raining
          state: 'off'
      then:
      - data: {}
        target:
          entity_id: cover.switcher_runner
        action: cover.open_cover
      else:
      - target:
          entity_id:
          - cover.switcher_runner
        data:
          position: 19
        action: cover.set_cover_position
    - action: number.set_value
      metadata: {}
      data:
        value: '50'
      target:
        entity_id: number.dreame_robot_vacuum_d9_volume
    - action: select.select_option
      metadata: {}
      data:
        option: standard
      target:
        entity_id: select.dreame_robot_vacuum_d9_suction_level
  mode: single
- id: backlight_tv
  alias: Backlight TV
  description: ''
  triggers:
  - entity_id:
    - media_player.mitv
    to: 'on'
    id: turn_on
    for:
      hours: 0
      minutes: 0
      seconds: 5
    enabled: true
    trigger: state
  - entity_id:
    - media_player.mitv
    id: turn_off
    from: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 5
    enabled: true
    trigger: state
  conditions: []
  actions:
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - if:
    - condition: trigger
      id: turn_on
    - condition: not
      conditions:
      - condition: state
        entity_id: media_player.mitv_adb
        state: 'off'
    then:
    - condition: state
      entity_id: light.wled_backlight_tv
      state: 'off'
    - wait_for_trigger:
      - entity_id:
        - media_player.mitv_adb
        to: 'on'
        trigger: state
      timeout:
        hours: 0
        minutes: 0
        seconds: 10
        milliseconds: 0
    - data: {}
      target:
        entity_id: input_boolean.hyperion_activation
      action: input_boolean.turn_off
    - data:
        color_temp: 330
        brightness_pct: 50
        effect: Solid
        transition: 10
      target:
        entity_id: light.wled_backlight_tv
      action: light.turn_on
    else:
    - data: {}
      target:
        entity_id: input_boolean.hyperion_activation
      action: input_boolean.turn_off
    - delay:
        hours: 0
        minutes: 0
        seconds: 7
        milliseconds: 0
    - data:
        transition: 20
      target:
        entity_id: light.wled_backlight_tv
      action: light.turn_off
  mode: queued
  max: 10
- id: mode_changer_shabbat
  alias: Mode changer - Shabbat
  description: Turns Shabbos Mode ON/OFF depending on existing mode
  triggers:
  - trigger: time
    at: sensor.jewish_calendar_upcoming_havdalah
    id: 'off'
  - trigger: time
    at:
      entity_id: sensor.jewish_calendar_upcoming_candle_lighting
      offset: -01:00:00
    id: 'on'
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id:
        - 'on'
      - condition: state
        entity_id: input_select.mode
        state: Home
      - condition: state
        entity_id: binary_sensor.is_early_shabbat
        state: 'off'
      sequence:
      - delay:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
      - if:
        - condition: state
          entity_id: input_select.mode
          state: Home
        then:
        - target:
            entity_id: input_select.mode
          data:
            option: Shabbat
          action: input_select.select_option
    - conditions:
      - condition: trigger
        id:
        - 'on'
      - condition: state
        entity_id: input_select.mode
        state: Home
      - condition: state
        state: 'on'
        entity_id: binary_sensor.is_early_shabbat
      sequence:
      - target:
          entity_id: input_select.mode
        data:
          option: Shabbat
        action: input_select.select_option
    - conditions:
      - condition: trigger
        id:
        - 'off'
      - condition: state
        entity_id: input_select.mode
        state: Shabbat
      sequence:
      - target:
          entity_id: input_select.mode
        data:
          option: Home
        action: input_select.select_option
      - data: {}
        target:
          entity_id:
          - input_boolean.guests
          - input_boolean.guests_shabbat_dinner
        action: input_boolean.turn_off
      - data: {}
        target:
          entity_id: input_boolean.delay_shabbat
        enabled: true
        action: input_boolean.turn_off
    default: []
  mode: single
- id: shabbat_0
  alias: Shabbat 0 - shabbat entrance routine
  description: On mode change to shabbat mode, activate the scene and notify
  triggers:
  - entity_id: input_select.mode
    to: Shabbat
    trigger: state
  conditions: []
  actions:
  - data:
      message: רוטינות שבת החלה
      data:
        tag: shabbat-mode
    action: notify.mobile_app_aviad_phone
    enabled: true
  - metadata: {}
    data:
      addon: d5369777_music_assistant
    action: hassio.addon_stop
    enabled: true
  - data: {}
    target:
      entity_id: scene.shabbat_0_sunset
    enabled: true
    action: scene.turn_on
  - data: {}
    target:
      entity_id:
      - media_player.mitv
      - media_player.mitv_adb
    enabled: true
    action: media_player.turn_off
  - data: {}
    action: script.set_up_sonos_group
    enabled: true
  - data:
      message: שבת נכנסת! השבת נקרא את פרשת...
      chime_path: choir
      cache: true
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  - data:
      message: '{% if states(''sensor.jewish_calendar_parshat_hashavua'') != ''none''
        %} {{ states(''sensor.jewish_calendar_parshat_hashavua'') }} {% else %} {{
        states(''sensor.jewish_calendar_holiday'') }} {% endif %}

        '
      chime_path: classical
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  - data:
      message: "השבת {% if states('input_boolean.guests_shabbat_dinner') == 'on'\n
        %}יש{% else %}אין{% endif %} אורחים! לא לשכוח לכבות את האור במקרר!"
      cache: true
      tts_platform: google_translate
      end_chime_path: fanfare
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  - delay:
      hours: 0
      minutes: 0
      seconds: 1
      milliseconds: 0
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: paused
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
  - action: script.get_random_song_from_playlist
    metadata: {}
    data:
      playlist_id: 07c13wipxpcwEl7eMRJRjk
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: playing
      trigger: state
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      trigger: state
      from: playing
  - metadata: {}
    data:
      volume_level: 0.4
    target:
      entity_id:
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: media_player.volume_set
- id: mode_changer_away
  alias: Mode changer - Away
  description: Turns Away Mode ON/OFF depending on existing mode
  trigger:
  - platform: state
    entity_id: group.family
  condition: []
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{trigger.to_state.state == ''not_home''}}'
      - condition: state
        entity_id: input_select.mode
        state: Home
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.mode
        data:
          option: Away
    - conditions:
      - condition: template
        value_template: '{{trigger.to_state.state == ''home''}}'
      - condition: state
        entity_id: input_select.mode
        state: Away
      sequence:
      - service: input_select.select_option
        target:
          entity_id: input_select.mode
        data:
          option: Home
    default: []
  mode: single
- id: shabbat_5
  alias: Shabbat 5 - shabbat exists routine
  description: On mode change to shabbat mode, activate the scene and notify
  trigger:
  - entity_id:
    - input_select.mode
    platform: state
    from: Shabbat
  condition: []
  action:
  - service: script.set_up_sonos_group
    data: {}
  - service: chime_tts.say
    data:
      message: שבת יצאה. שבוע טוב לכולם
      chime_path: choir
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
  - delay:
      hours: 0
      minutes: 0
      seconds: 10
      milliseconds: 0
  - service: media_player.unjoin
    data: {}
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
      - media_player.sonos_kids_bedroom
  - service: notify.mobile_app_aviad_phone
    data:
      message: clear_notification
      data:
        tag: shabbat-mode
  - service: media_player.volume_set
    metadata: {}
    data:
      volume_level: 0.25
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
  - service: hassio.addon_start
    metadata: {}
    data:
      addon: d5369777_music_assistant
  mode: single
- id: lights_out
  alias: Lights out
  description: ''
  triggers:
  - at: 08:00:00
    trigger: time
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      enabled: true
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: person.noga
    state: not_home
  actions:
  - variables:
      current_bedroom_fan_state: '{{ states(''fan.bedroom_fan'') }}'
  - target:
      entity_id: scene.lights_out
    metadata: {}
    action: scene.turn_on
  - if:
    - condition: state
      entity_id: binary_sensor.bedroom_occupancy_sensor_occupancy
      state: 'on'
    then:
    - metadata: {}
      data: {}
      target:
        entity_id: fan.bedroom_fan
      action: fan.turn_{{ current_bedroom_fan_state }}
  mode: single
- id: kitchen_md
  alias: Kitchen motion detection
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.kitchen_motion_sensor
    trigger: state
    to: 'on'
    from: 'off'
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: person.noga
      state: home
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: time
    after: 07:00:00
    enabled: true
    before: '18:00:00'
    weekday:
    - sun
    - mon
    - tue
    - wed
    - thu
  actions:
  - data: {}
    target:
      entity_id: light.kitchen_switch
    action: light.turn_on
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.espresense_kitchen_occupancy
      from: 'on'
      to: 'off'
      for:
        hours: 0
        minutes: 5
        seconds: 0
      trigger: state
    timeout:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: person.noga
      state: home
  - condition: time
    before: '18:00:00'
  - data: {}
    target:
      entity_id: light.kitchen_switch
    action: light.turn_off
  mode: restart
- id: bed_md
  alias: Bed motion detection
  description: ''
  triggers:
  - from: 'off'
    to: 'on'
    entity_id: binary_sensor.bed_motion_sensor
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: sun.sun
    state: below_horizon
  - condition: and
    conditions:
    - condition: or
      conditions:
      - condition: state
        entity_id: media_player.projector
        state: unavailable
      - condition: state
        entity_id: media_player.projector
        state: 'off'
    - condition: or
      conditions:
      - condition: state
        entity_id: remote.mibox3
        state: unavailable
      - condition: state
        entity_id: remote.mibox3
        state: 'off'
  actions:
  - data: {}
    target:
      entity_id: light.bed_led_strip
    action: light.turn_on
  - wait_for_trigger:
    - from: 'on'
      to: 'off'
      entity_id: binary_sensor.bed_motion_sensor
      trigger: state
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - delay:
      hours: 0
      minutes: 0
      seconds: 40
      milliseconds: 0
  - data: {}
    target:
      entity_id: light.bed_led_strip
    action: light.turn_off
  mode: restart
- id: light_on_door
  alias: Lights on when opening door
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.door_sensor
    to: 'on'
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: or
    conditions:
    - condition: state
      state: below_horizon
      entity_id: sun.sun
    - condition: numeric_state
      entity_id: cover.switcher_runner
      below: 10
      attribute: current_position
  actions:
  - action: scene.create
    metadata: {}
    data:
      scene_id: before_door
      snapshot_entities:
      - light.wled_kitchen
  - data:
      kelvin: 5390
      effect: solid
      brightness_pct: 75
    target:
      entity_id:
      - light.entrance_bulb
      - light.wled_kitchen
    action: light.turn_on
  - continue_on_error: true
    data:
      kelvin: 2070
    target:
      entity_id:
      - light.small_kids_bedroom
      - light.bathroom_bulb
    action: light.turn_on
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.door_sensor
      trigger: state
      to: 'off'
      for:
        hours: 0
        minutes: 0
        seconds: 5
    timeout:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - delay:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
  - data: {}
    target:
      entity_id:
      - light.entrance_bulb
    action: light.turn_off
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_door
  - action: scene.delete
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_door
  mode: single
- id: shabbat_1
  alias: Shabbat 1 - candle light plag
  description: ''
  trigger:
  - platform: template
    value_template: '{{ as_timestamp(states(''sensor.jewish_calendar_plag_hamincha''))|timestamp_custom(''%H:%M'',
      true) == as_timestamp(now())|timestamp_custom(''%H:%M'', true) }}'
  condition:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: state
    entity_id: binary_sensor.is_early_shabbat
    state: 'on'
  - condition: not
    conditions:
    - condition: time
      weekday:
      - sat
  action:
  - service: chime_tts.say
    data:
      message: זמן הדלקת נרות
      chime_path: choir
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
  mode: single
- id: alert_high_temp
  alias: Alert when high temperature
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.processor_temperature
    for:
      hours: 0
      minutes: 10
      seconds: 0
    above: 67
  condition: []
  action:
  - service: notify.mobile_app_aviad_phone
    data:
      message: Temperature is {{ states("sensor.processor_temperature") }}
      title: Temperature is too high
  mode: single
- id: alert_omer
  alias: Alert when Sfirat HaOmer
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.jewish_calendar_day_of_the_omer
    for:
      hours: 0
      minutes: 36
      seconds: 0
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: sensor.jewish_calendar_day_of_the_omer
      state: '0'
  - condition: not
    conditions:
    - condition: template
      value_template: '{{trigger.from_state.state == ''unknown''}}'
  action:
  - variables:
      message: '{% set totalDays = states(''sensor.jewish_calendar_day_of_the_omer'')
        | int %}{% set weeks = totalDays // 7 %}{% set daysInWeek = totalDays %7 %}{%
        set lsb = totalDays % 10 %}{% set msb = totalDays - lsb %}הַיּוֹם{% if totalDays
        == 1 %} יוֹם אֶחָד{% elif totalDays > 1 and totalDays < 7 %}{{ totalDays }}
        יָמִים{% else %} {% if totalDays < 21 or lsb == 0 %}{{ totalDays }}{% else
        %}{{ lsb }} וְ- {{ msb }}{% endif %} {% if totalDays < 11 %} יָמִים {% else
        %} יוֹם {% endif %} {% if weeks < 2 %}שֶׁהֵם שָׁבוּעַ אֶחָד {% else %}שֶׁהֵם
        {{ weeks }} שָׁבוּעוֹת {% endif %} {% if daysInWeek == 1 %}וְיוֹם אֶחָד {%
        elif daysInWeek > 1 %}וְ- {{ daysInWeek }} יָמִים {% endif %}{% endif %}לָעומֶר

        '
  - service: notify.home_assistant_telegram
    data:
      message: '{{ message }}

        '
  - service: chime_tts.say
    data:
      chime_path: toast
      offset: 1000
      announce: true
      language: iw
      tts_platform: google_translate
      message: '{{ message }}

        '
    target:
      entity_id: media_player.sonos_living_room
    enabled: true
  mode: single
- id: alert_washing_machine_finished
  alias: Fire event when washing machine finished
  description: ''
  triggers:
  - entity_id: sensor.washing_machine_socket_power
    for:
      minutes: 5
    above: 5
    trigger: numeric_state
  - trigger: homeassistant
    event: start
  conditions:
  - condition: numeric_state
    entity_id: sensor.washing_machine_socket_power
    above: 5
  actions:
  - wait_for_trigger:
    - entity_id: sensor.washing_machine_socket_power
      below: 3
      for:
        minutes: 4
      trigger: numeric_state
  - if:
    - condition: state
      entity_id: binary_sensor.washing_machine_contact_sensor
      state: 'off'
    then:
    - event: washing_machine_finished
      event_data: {}
  mode: single
  max_exceeded: silent
- id: alert_phone_low_battery_aviad
  alias: Alert when phone low battery - Aviad
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.aviad_phone_battery_level
    below: input_number.low_battery_level_aviad
  - platform: state
    entity_id:
    - binary_sensor.aviad_phone_is_charging
    to: 'off'
    for:
      hours: 0
      minutes: 15
      seconds: 0
  condition:
  - condition: state
    entity_id: sun.sun
    state: above_horizon
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  - condition: state
    entity_id: binary_sensor.aviad_phone_is_charging
    state: 'off'
  - condition: numeric_state
    entity_id: sensor.aviad_phone_battery_level
    below: input_number.low_battery_level_aviad
  action:
  - repeat:
      until:
      - condition: or
        conditions:
        - condition: state
          entity_id: binary_sensor.aviad_phone_is_charging
          state: 'on'
        - condition: state
          entity_id: input_select.mode
          state: Shabbat
        - condition: numeric_state
          entity_id: sensor.aviad_phone_battery_level
          above: input_number.low_battery_level_aviad
        - condition: state
          entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
          state: 'on'
      sequence:
      - data:
          message: clear_notification
          data:
            tag: aviad_low_battery
        action: notify.mobile_app_aviad_phone
      - data:
          message: Low battery
          data:
            actions:
            - action: long_snooze_low_battery_notification
              title: Longer Snooze
            tag: aviad_low_battery
        action: notify.mobile_app_aviad_phone
      - delay:
          hours: 0
          minutes: 20
          seconds: 0
          milliseconds: 0
      - if:
        - condition: state
          entity_id: input_boolean.longer_low_battery_snooze
          state: 'on'
        then:
        - delay:
            hours: 0
            minutes: 40
            seconds: 0
            milliseconds: 0
        - data: {}
          target:
            entity_id: input_boolean.longer_low_battery_snooze
          action: input_boolean.turn_off
  mode: single
- id: alert_phone_low_battery_noga
  alias: Alert when phone low battery - Noga
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.noga_phone_battery_level
    below: 40
  condition:
  - condition: state
    entity_id: sun.sun
    state: above_horizon
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  - condition: state
    entity_id: binary_sensor.noga_phone_is_charging
    state: 'off'
  action:
  - service: notify.mobile_app_noga_phone
    data:
      message: Low battery
  mode: single
- id: tag_scanned_parent_bathroom
  alias: Tag parent bathroom is scanned
  description: ''
  trigger:
  - platform: tag
    tag_id: 17137ac4-9193-4ce7-a194-43126a8b63b9
  condition: []
  action:
  - service: light.toggle
    data: {}
    target:
      entity_id: light.parents_bathroom_lights
  mode: single
- id: lights_washing_machine_finished
  alias: When washing machine finished
  description: ''
  triggers:
  - event_type: washing_machine_finished
    trigger: event
  conditions: []
  actions:
  - data:
      message: מכונת הכביסה סיימה
    action: notify.mobile_app_noga_phone
  - data:
      rgb_color:
      - 17
      - 0
      - 255
    target:
      entity_id: light.balcony_bulb
    action: light.turn_on
  - parallel:
    - repeat:
        until:
        - condition: or
          conditions:
          - condition: state
            entity_id: binary_sensor.washing_machine_contact_sensor
            state: 'on'
          - condition: state
            entity_id: input_boolean.washing_machine_tag_scanned
            state: 'on'
        sequence:
        - if:
          - condition: state
            entity_id: media_player.mitv_adb
            state: playing
          then:
          - data:
              message: מכונת הכביסה סיימה
            action: notify.mi_tv
          - target:
              entity_id: media_player.sonos_kitchen
            data:
              offset: 500
              announce: true
              language: iw
              message: מכונת הכביסה סיימה
              tts_platform: google_translate
              chime_path: chord
              cache: true
            enabled: true
            action: chime_tts.say
          else:
          - target:
              entity_id:
              - media_player.sonos_kitchen
              - media_player.sonos_living_room
            data:
              offset: 500
              announce: true
              language: iw
              message: מכונת הכביסה סיימה
              tts_platform: google_translate
              chime_path: chord
              join_players: true
              cache: true
              unjoin_players: true
            enabled: true
            action: chime_tts.say
        - delay:
            hours: 0
            minutes: 10
            seconds: 0
            milliseconds: 0
    - sequence:
      - wait_for_trigger:
        - entity_id:
          - binary_sensor.washing_machine_contact_sensor
          to: 'on'
          trigger: state
        - tag_id: 93d413b2-e019-43c7-a394-ad8db3bc8f34
          trigger: tag
        timeout:
          hours: 1
          minutes: 0
          seconds: 0
          milliseconds: 0
      - data:
          color_temp: 153
          brightness_pct: 100
        target:
          entity_id: light.balcony_bulb
        action: light.turn_on
      - if:
        - condition: state
          entity_id: sun.sun
          state: above_horizon
        then:
        - delay:
            hours: 0
            minutes: 0
            seconds: 5
            milliseconds: 0
        else:
        - delay:
            hours: 0
            minutes: 30
            seconds: 0
            milliseconds: 0
      - data: {}
        target:
          entity_id: light.balcony_bulb
        action: light.turn_off
  mode: single
- id: shabbat_guests
  alias: Guests for Shabbat
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.guests
    to: 'on'
  condition: []
  action:
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.guests_shabbat_dinner
  mode: single
- id: shabbat_2
  alias: Shabbat 2 - lights scenes
  description: ''
  triggers:
  - event: sunset
    offset: '1:00:00'
    id: shabbat_1_evening_house
    trigger: sun
  - id: shabbat_2_night_house
    at: input_datetime.shabbat_lights_out
    trigger: time
  - at: input_datetime.shabbat_morning_lights_on
    id: shabbat_3_morning_house
    enabled: true
    trigger: time
  - at: '10:30:00'
    id: shabbat_3_morning_meal
    enabled: true
    trigger: time
  - at: input_datetime.shabbat_noon_lights_out
    id: shabbat_4_day_house
    enabled: true
    trigger: time
  - event: sunset
    offset: -01:30:00
    id: shabbat_5_sunset_house
    enabled: true
    trigger: sun
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: shabbat_1_evening_house
      - condition: time
        after: 00:00:00
        before: input_datetime.shabbat_lights_out
      sequence:
      - if:
        - condition: state
          entity_id: binary_sensor.is_early_shabbat
          state: 'off'
        then:
        - delay:
            hours: 1
            minutes: 0
            seconds: 0
            milliseconds: 0
        else: []
      - if:
        - condition: time
          before: input_datetime.shabbat_night_baseline_routine
          after: 00:00:00
        then:
        - wait_for_trigger:
          - at: input_datetime.shabbat_night_baseline_routine
            trigger: time
        else: []
      - if:
        - condition: state
          entity_id: input_boolean.guests_shabbat_dinner
          state: 'on'
        then:
        - delay:
            hours: 1
            minutes: 0
            seconds: 0
            milliseconds: 0
        else: []
      - if:
        - condition: time
          after: 00:00:00
          before: input_datetime.shabbat_lights_out
        then:
        - scene: scene.shabbat_1_evening
        - data: {}
          target:
            entity_id: light.bed_led_strip
          action: light.turn_on
    - conditions:
      - condition: trigger
        id: shabbat_2_night_house
      sequence:
      - scene: scene.shabbat_2_goodnight
      - target:
          entity_id: cover.switcher_runner
        data:
          position: 9
        action: cover.set_cover_position
    - conditions:
      - condition: trigger
        id: shabbat_3_morning_house
      sequence:
      - if:
        - condition: or
          conditions:
          - condition: numeric_state
            entity_id: sensor.average_cloudiness_1h
            above: 60
          - condition: numeric_state
            entity_id: sensor.pirateweather_cloud_coverage
            above: 60
        then:
        - target:
            entity_id: scene.shabbat_3_morning_cloudy
          metadata: {}
          action: scene.turn_on
        else:
        - target:
            entity_id: scene.shabbat_3_morning
          metadata: {}
          action: scene.turn_on
    - conditions:
      - condition: trigger
        id: shabbat_3_morning_meal
      sequence:
      - if:
        - condition: or
          conditions:
          - condition: numeric_state
            entity_id: sensor.average_cloudiness_1h
            above: 60
          - condition: numeric_state
            entity_id: sensor.pirateweather_cloud_coverage
            above: 60
        then:
        - target:
            entity_id: scene.shabbat_3_morning_cloudy
          metadata: {}
          action: scene.turn_on
    - conditions:
      - condition: trigger
        id: shabbat_4_day_house
      - condition: numeric_state
        entity_id: cover.switcher_runner
        attribute: current_position
        above: 20
      - condition: numeric_state
        entity_id: sensor.average_cloudiness_1h
        below: 60
      - condition: numeric_state
        entity_id: sensor.pirateweather_cloud_coverage
        below: 60
      sequence:
      - scene: scene.shabbat_2_goodnight
    - conditions:
      - condition: trigger
        id: shabbat_5_sunset_house
      sequence:
      - scene: scene.shabbat_0_sunset
    default: []
  mode: queued
  max: 10
- id: shabbat_3
  alias: Shabbat 3 - fans scenes
  description: ''
  triggers:
  - entity_id:
    - input_select.mode
    to: Shabbat
    id: all_fans
    enabled: true
    trigger: state
  - at: '21:25:00'
    id: all_fans
    enabled: false
    trigger: time
  - at: '23:00:00'
    id: bedroom_fans
    enabled: true
    trigger: time
  - at: 07:00:00
    id: all_fans
    enabled: true
    trigger: time
  - at: 09:37:00
    enabled: false
    id: no_fans
    trigger: time
  - at: '13:53:00'
    id: all_fans
    enabled: false
    trigger: time
  - at: '15:15:00'
    enabled: false
    id: no_fans
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: all_fans
      sequence:
      - target:
          entity_id: scene.shabbat_fans_on
        metadata: {}
        action: scene.turn_on
      - if:
        - condition: state
          entity_id: input_boolean.guests
          state: 'on'
        then:
        - data: {}
          target:
            entity_id: fan.office_fan
          action: fan.turn_on
    - conditions:
      - condition: trigger
        id: bedroom_fans
      sequence:
      - target:
          entity_id: scene.shabbat_bedroom_fans_on
        metadata: {}
        action: scene.turn_on
      - if:
        - condition: state
          entity_id: input_boolean.guests
          state: 'on'
        then:
        - data: {}
          target:
            entity_id: fan.office_fan
          action: fan.turn_on
    - conditions:
      - condition: trigger
        id: no_fans
      sequence:
      - target:
          entity_id: scene.fans_out
        metadata: {}
        action: scene.turn_on
    - conditions:
      - condition: trigger
        id: living_room_fan
      sequence:
      - target:
          entity_id: scene.shabbat_living_room_fans_on
        metadata: {}
        action: scene.turn_on
    default: []
  mode: single
- id: tag_scanned_waching_machine
  alias: Washing machine tag state
  description: ''
  trigger:
  - platform: tag
    tag_id: 93d413b2-e019-43c7-a394-ad8db3bc8f34
  condition: []
  action:
  - service: light.turn_on
    data:
      color_temp: 153
      brightness_pct: 100
    target:
      entity_id: light.balcony_bulb
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.washing_machine_tag_scanned
  - delay:
      hours: 0
      minutes: 40
      seconds: 0
      milliseconds: 0
  - service: input_boolean.turn_off
    data: {}
    target:
      entity_id: input_boolean.washing_machine_tag_scanned
  mode: single
- id: zigbee_switch_balcony
  alias: Zigbee balcony switch automation
  description: ''
  use_blueprint:
    path: homeassistant/sonoff_switch.yaml
    input:
      sonoff_button: 32b1a46b19821e2f7655e149ba39da85
      toggle_action:
      - service: light.toggle
        data:
          color_temp: 153
          brightness_pct: 100
        target:
          entity_id: light.balcony_bulb
      on_action:
      - service: light.turn_on
        data:
          color_temp: 153
        target:
          entity_id: light.balcony_bulb
- id: zigbee_switch_parents_bathroom
  alias: Zigbee parents bathroom switch automation
  description: ''
  use_blueprint:
    path: homeassistant/sonoff_switch.yaml
    input:
      sonoff_button: aae1c5bf1cd8c2ed601df34d695457a4
      toggle_action:
      - service: light.toggle
        data: {}
        target:
          entity_id:
          - light.parent_bathroom_bulb
      on_action:
      - service: light.toggle
        data: {}
        target:
          entity_id: light.parents_bathroom_lights
      off_action:
      - service: light.turn_on
        data: {}
        target:
          entity_id: light.parents_bathroom_lights
- id: alert_download_finished
  alias: Alert when download is finished
  description: ''
  trigger:
  - platform: numeric_state
    entity_id: sensor.qbittorrent_down_speed
    for:
      hours: 0
      minutes: 10
      seconds: 0
    below: 1
  condition:
  - condition: template
    value_template: '{{trigger.from_state.state != ''unavailable''}}'
  action:
  - service: notify.mobile_app_aviad_phone
    data:
      message: Download completed
      title: Qbittorent
      data:
        actions:
        - action: URI
          title: Open Qbittorrent
          uri: /db21ed7f_qbittorrent/dashboard
        tag: download-finished
  mode: restart
- id: ble_transimitter_active_when_home
  alias: BLE transmitter active only at home
  description: ''
  trigger:
  - platform: state
    entity_id:
    - device_tracker.aviad_phone
    for:
      hours: 0
      minutes: 3
      seconds: 0
    from: home
    to: not_home
  - platform: state
    entity_id:
    - device_tracker.aviad_phone
    from: not_home
    to: home
    for:
      hours: 0
      minutes: 3
      seconds: 0
  condition: []
  action:
  - if:
    - condition: state
      entity_id: device_tracker.aviad_phone
      state: not_home
      for:
        hours: 0
        minutes: 0
        seconds: 0
    then:
    - service: notify.mobile_app_aviad_phone
      data:
        message: command_ble_transmitter
        data:
          command: turn_off
    else:
    - service: notify.mobile_app_aviad_phone
      data:
        message: command_ble_transmitter
        data:
          command: turn_on
  mode: single
- id: showert_morning
  alias: Shower in the morning
  description: ''
  triggers:
  - at: 06:15:00
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: state
    entity_id: input_boolean.morning_shower
    state: 'on'
  actions:
  - data:
      timer_minutes: 30
    target:
      entity_id: switch.switcher_home
    action: switcher_kis.turn_on_with_timer
  - data: {}
    target:
      entity_id: input_boolean.morning_shower
    action: input_boolean.turn_off
  mode: single
- id: vacuum_when_away
  alias: Vacuum when away
  description: ''
  triggers:
  - entity_id:
    - input_select.mode
    to: Away
    for:
      hours: 0
      minutes: 10
      seconds: 0
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.vacuum_when_away
    state: 'on'
  actions:
  - data:
      segments:
      - 3
      - 10
      - 9
    target:
      entity_id: vacuum.dreame_robot_vacuum_d9
    action: dreame_vacuum.vacuum_clean_segment
  - data: {}
    target:
      entity_id: input_boolean.vacuum_when_away
    action: input_boolean.turn_off
  mode: single
- id: kids_heater_routine
  alias: Kids heater climate routine
  description: ''
  trigger:
  - platform: state
    entity_id:
    - schedule.kids_heater_climate_scheduler
    to: 'on'
    from: 'off'
    id: to_on
  - platform: state
    entity_id:
    - schedule.kids_heater_climate_scheduler
    to: 'off'
    from: 'on'
    id: to_off
  condition:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id: to_on
      - condition: not
        conditions:
        - condition: state
          entity_id: input_select.mode
          state: Away
    - condition: trigger
      id: to_off
  action:
  - service: climate.turn_{{ trigger.to_state.state }}
    data: {}
    target:
      entity_id: climate.kids_bedroom
  mode: single
- id: kids_heater_switch
  alias: Kids heater climate - connect to switch
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.smart_plug_il
    to: 'on'
    from: 'off'
    id: to_on
  condition:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id: to_on
      - condition: not
        conditions:
        - condition: state
          entity_id: input_select.mode
          state: Away
    - condition: trigger
      id: to_off
  action:
  - service: climate.turn_{{ trigger.to_state.state }}
    data: {}
    target:
      entity_id: climate.kids_bedroom
  mode: single
- id: mobile_event_longer_battery_notification_snooze
  alias: Mobile Event Fired - Longer low notification snooze
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: long_snooze_low_battery_notification
  condition: []
  action:
  - service: input_boolean.turn_on
    data: {}
    target:
      entity_id: input_boolean.longer_low_battery_snooze
  mode: single
- id: kids_heater_hass_restart
  alias: Kids heater when home assistant restart
  description: ''
  triggers:
  - event: start
    trigger: homeassistant
  - trigger: state
    entity_id:
    - input_select.mode
    to: Home
  conditions:
  - condition: and
    conditions:
    - condition: not
      conditions:
      - condition: state
        entity_id: input_select.mode
        state: Away
    - condition: state
      entity_id: schedule.kids_heater_climate_scheduler
      state: 'on'
  actions:
  - data: {}
    target:
      entity_id: climate.kids_bedroom
    action: climate.turn_on
  mode: single
- id: alert_cloudy_day
  alias: Alert when cluody day
  description: ''
  triggers:
  - at: '16:30:00'
    trigger: time
    id: weekday
  - trigger: time
    at: '12:00:00'
    id: Friday
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  - condition: numeric_state
    entity_id: sensor.average_cloudiness_8h
    above: 65
  - condition: state
    entity_id: switch.switcher_home
    state: 'off'
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id:
        - Friday
      - condition: time
        weekday:
        - fri
    - condition: and
      conditions:
      - condition: trigger
        id:
        - weekday
      - condition: time
        weekday:
        - thu
        - wed
        - tue
        - mon
        - sun
  actions:
  - data:
      message: We had {{states('sensor.average_cloudiness_8h')}} % average cloud coverage
        for the last 8h
      data:
        actions:
        - action: turn_on_boiler_notification
          title: Turn on boiler for 30min
        - action: boiler_dismiss
          title: Dismiss
        tag: cloudy-day-alert
      title: Cloudy day
    action: notify.aviad_and_noga_mobiles
  - wait_for_trigger:
    - event_type: mobile_app_notification_action
      event_data:
        tag: cloudy-day-alert
      trigger: event
    timeout:
      hours: 1
      minutes: 30
      seconds: 0
      milliseconds: 0
  - if:
    - condition: template
      value_template: '{{ wait.trigger and wait.trigger.event.data.action == ''turn_on_boiler_notification''
        }}'
    then:
    - data:
        timer_minutes: 30
      target:
        entity_id: switch.switcher_home
      action: switcher_kis.turn_on_with_timer
  - data:
      message: clear_notification
      data:
        tag: cloudy-day-alert
    action: notify.aviad_and_noga_mobiles
  mode: single
- id: backlight_tv_music
  alias: Backlight TV Music
  description: ''
  triggers:
  - entity_id:
    - media_player.sonos_living_room
    for:
      hours: 0
      minutes: 0
      seconds: 5
    to: playing
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.sonos_living_room
      attribute: source
      state: TV
  actions:
  - action: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.wled_backlight_tv_sync_send
      - switch.wled_kitchen_sync_receive
  - data:
      effect: '{{ state_attr("light.wled_backlight_tv", "effect_list")[1:118] | reject("equalto",
        "RSVD") | list | random }}'
    target:
      entity_id: light.wled_backlight_tv
    action: light.turn_on
  - target:
      entity_id: select.wled_backlight_tv_color_palette
    data:
      option: '{{ state_attr(''select.wled_backlight_tv_color_palette'', ''options'')
        | random }}'
    action: select.select_option
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      from: playing
      for:
        hours: 0
        minutes: 0
        seconds: 7
      trigger: state
    timeout:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - data: {}
    target:
      entity_id: light.wled_backlight_tv
    action: light.turn_off
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.wled_backlight_tv_sync_send
      - switch.wled_kitchen_sync_receive
  mode: restart
- id: hyperion_activation
  alias: Hyperion Activation
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.hyperion_activation
    from: 'on'
    to: 'off'
  - platform: state
    entity_id:
    - input_boolean.hyperion_activation
    from: 'off'
    to: 'on'
  condition: []
  action:
  - if:
    - condition: state
      entity_id: input_boolean.hyperion_activation
      state: 'on'
    then:
    - service: script.activate_hyperion
      data: {}
    else:
    - service: script.disable_hyperion
      data: {}
  mode: single
- id: alert_noga_heading_home
  alias: Alert when Noga is heading home
  description: ''
  triggers:
  - entity_id:
    - sensor.noga_distance
    for:
      hours: 0
      minutes: 0
      seconds: 0
    below: 2
    trigger: numeric_state
  - entity_id:
    - sensor.noga_direction_of_travel
    to: towards
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  conditions:
  - condition: state
    state: towards
    entity_id: sensor.noga_direction_of_travel
  - condition: numeric_state
    entity_id: sensor.noga_to_aviad_proximity
    above: 1
    enabled: true
  actions:
  - data:
      message: 'Distance: {{ states.sensor.noga_distance.state }} km. Waze time: {{
        states.sensor.waze_travel_noga.state }}'
      title: Noga is heading home
      data:
        tag: noga-headed-home
    action: notify.mobile_app_aviad_phone
  mode: single
- id: office_md
  alias: Office motion detection
  description: ''
  triggers:
  - from: 'off'
    to: 'on'
    entity_id:
    - binary_sensor.office_occupancy_sensor_occupancy
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: sun.sun
    state: below_horizon
  - condition: state
    entity_id: input_boolean.guests
    state: 'off'
  actions:
  - data:
      rgb_color:
      - 17
      - 0
      - 255
      brightness_pct: 50
    target:
      entity_id:
      - light.office_desk_light
    action: light.turn_on
  - wait_for_trigger:
    - from: 'on'
      to: 'off'
      entity_id:
      - binary_sensor.office_occupancy_sensor_occupancy
      trigger: state
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - delay:
      hours: 0
      minutes: 0
      seconds: 40
      milliseconds: 0
  - data: {}
    target:
      entity_id:
      - light.office_desk_light
    action: light.turn_off
  mode: restart
- id: one_time_automation_noga_home
  alias: One-time automation - Alert when Nogs is home
  description: ''
  trigger:
  - platform: state
    entity_id:
    - person.noga
    to: home
    enabled: true
  condition: []
  action:
  - service: notify.mobile_app_noga_phone
    data:
      title: תזכורת
      message: "\U0001F489"
    enabled: true
  - service: automation.turn_off
    data:
      stop_actions: true
    enabled: true
    target:
      entity_id: automation.one_time_automation_alert_when_nogs_is_home
  mode: single
- id: dismiss_Alert_when_charging
  alias: Dismiss alert when charging
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.aviad_phone_is_charging
    to: 'on'
  condition: []
  action:
  - service: notify.mobile_app_aviad_phone
    data:
      message: clear_notification
      data:
        tag: aviad_low_battery
  mode: single
- id: alert_when_raining
  alias: Alert when raining
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.is_raining
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition:
  - condition: numeric_state
    entity_id: cover.switcher_runner
    above: 20
    attribute: current_position
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
  action:
  - service: notify.aviad_and_noga_mobiles
    data:
      message: It's raining. Do you want to close the shutter in the living room?
      data:
        actions:
        - action: close_shutter_notification
          title: Close shutter
        - action: shutter_dismiss
          title: Dismiss
        tag: rain-alert
      title: Rain
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        tag: rain-alert
    - platform: state
      entity_id:
      - binary_sensor.is_raining
      to: 'off'
    timeout:
      hours: 1
      minutes: 0
      seconds: 0
      milliseconds: 0
    continue_on_timeout: true
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ wait.trigger and wait.trigger.event and wait.trigger.event.data
          and wait.trigger.event.data.action == ''close_shutter_notification'' }}'
      sequence:
      - service: cover.set_cover_position
        metadata: {}
        data:
          position: 19
        target:
          entity_id: cover.switcher_runner
      - service: notify.aviad_and_noga_mobiles
        data:
          message: clear_notification
          data:
            tag: rain-alert
    default:
    - service: notify.aviad_and_noga_mobiles
      data:
        message: clear_notification
        data:
          tag: rain-alert
  mode: single
- id: night_env_routine_shutter
  alias: Night environment routine - shutter
  description: ''
  trigger:
  - platform: time
    at: '22:30:00'
  condition:
  - condition: state
    entity_id: input_select.mode
    state: Home
  action:
  - service: cover.set_cover_position
    target:
      entity_id:
      - cover.switcher_runner
    data:
      position: 17
  mode: single
- id: alert_sonos_roam_low_battery
  alias: Alert on low Sonos Roam battery
  description: ''
  use_blueprint:
    path: jazakrzewski/send-notification-for-battery-level.yaml
    input:
      battery_entity: sensor.kids_bedroom_battery
      battery_level: 40
      notify_device: 4214920656084e3e0376f9a6c7b2eb48
- id: hyperion_per_app
  alias: Hyperion Activation per app
  description: ''
  triggers:
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: FreeTV
    id: turn_on
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: HDMI Input
    id: turn_off
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: Netflix
    id: turn_off
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: SmartTube
    id: turn_on
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    id: turn_on
    to: VLC
    trigger: state
  - entity_id:
    - media_player.mitv_adb
    attribute: app_name
    to: Android TV Launcher
    id: turn_off
    for:
      hours: 0
      minutes: 0
      seconds: 15
    trigger: state
  - entity_id:
    - media_player.mitv_2
    trigger: state
    attribute: media_title
    for:
      hours: 0
      minutes: 0
      seconds: 2
    id: title
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - turn_off
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id: input_boolean.hyperion_activation
        action: input_boolean.turn_off
    - conditions:
      - condition: or
        conditions:
        - condition: trigger
          id:
          - turn_on
        - condition: and
          conditions:
          - condition: trigger
            id:
            - title
          - condition: template
            value_template: '{{ state_attr(''media_player.mitv_2'', ''media_title'')
              == None }}


              '
      sequence:
      - target:
          entity_id: input_boolean.hyperion_activation
        data: {}
        action: input_boolean.turn_on
    - conditions:
      - condition: and
        conditions:
        - condition: trigger
          id:
          - title
        - condition: template
          value_template: '{{ state_attr(''media_player.mitv_2'', ''media_title'')
            != None and ''2160'' in state_attr(''media_player.mitv_2'', ''media_title'').lower()
            }}


            '
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id: input_boolean.hyperion_activation
        action: input_boolean.turn_off
      - wait_for_trigger:
        - trigger: state
          entity_id:
          - media_player.mitv_2
          attribute: media_title
        timeout:
          hours: 2
          minutes: 0
          seconds: 0
          milliseconds: 0
  mode: single
- id: alert_and_speak_day_agenda
  alias: Alert and speak day agenda
  description: ''
  triggers:
  - value_template: '{% if states(''binary_sensor.is_school_vacation'') == ''on''
      %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline''))  +
      timedelta(minutes = 15) + timedelta(minutes = (states(''input_number.morning_vacation_delay'')|
      int)) }}

      {% else %}

      {{ now() >= today_at(states(''input_datetime.morning_routine_baseline''))  +
      timedelta(minutes = 15) }}

      {% endif %}'
    trigger: template
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  actions:
  - data: {}
    enabled: true
    action: script.set_up_sonos_group
  - metadata: {}
    data:
      duration:
        hours: 17
        minutes: 0
        seconds: 0
    target:
      entity_id:
      - calendar.aviadlevy1_gmail_com
      - calendar.family
    response_variable: agenda
    action: calendar.get_events
  - metadata: {}
    data:
      text: "Location: Petah Tikva, Israel \nTime: {{ as_timestamp(now()) | timestamp_custom(\"%A
        %d/%m/%y\") }}\n{% set max_temp = state_attr('sensor.ims_forecast_today',
        'maximum_temperature') %} Weather:  {{ state_attr('sensor.ims_forecast_today',
        'weather').value }} (max of {{ max_temp.value}}{{max_temp.unit }}, {{ states('sensor.ims_precipitation_probability')}}%
        precipitation)\nPersonal calendar events today: {%- if agenda['calendar.aviadlevy1_gmail_com'].events
        %}\n  {%- for event in agenda['calendar.aviadlevy1_gmail_com'].events %}\n
        \ - Summary: {{ event.summary }}\n    Start: {% if event.start is defined
        %}{{ as_timestamp(event.start) | timestamp_custom(\"%H:%M\") }}{% else %}All
        Day{% endif %}\n  {%- endfor %}\n{%- else %}\n  - No upcoming events.\n{%-
        endif %} \nFamily calendar events today: {%- if agenda['calendar.family'].events
        %}\n  {%- for event in agenda['calendar.family'].events %}\n  - Summary: {{
        event.summary }}\n    Start: {% if event.start is defined %}{{ as_timestamp(event.start)
        | timestamp_custom(\"%H:%M\") }}{% else %}All Day{% endif %}\n  {%- endfor
        %}\n{%- else %}\n  - No upcoming events.\n{%- endif %} \nIs it school day?
        ->  {{ states('binary_sensor.is_school_vacation') == 'off' }}\nHebrew date
        to mention in message: '{{states('sensor.jewish_calendar_date').split()[:2]
        | join(\" \") }}'\nGenerate text for a notification that will be be heard
        in our house speakers. no emojis.\n- You are a helpful personal agent that
        generates text for the Levy family. your answer should always be in Hebrew
        language. Family members are: Dad, Mom, Yair, Ayala. in Hebrew spelled: אבא,
        אמא, יאיר, אַיָּלָה (או איילה)\n- Your answers are helpful, friendly, insightful
        and kids friendly.\n- Your messages help the user prepare for their day, for
        example:\n  - Making note of unusual weather for the location and time of
        year (but not mundane details like \"0% chance of precipitation\")\n  - Anything
        that may be special or unique, such as celebrating a birthday\n- Your message
        should not be longer than 600 tokens! this is a hard requirement!\n- Your
        priority so everything can be in that message is:\n  - Weather forcast, but
        ignore if temperature is 0. it means something went wrong\n  - Upcoming calendar
        events\n  - adding a joke or an insightful thing\n- Your answer should contain
        3 paragraphs, and 1 short goodbye paragraph. "
      agent_id: conversation.gemini_pro
    response_variable: agent
    action: conversation.process
  - data:
      message: '{{ agent.response.speech.plain.speech }}'
    action: notify.home_assistant_telegram
  - data:
      offset: 500
      message: '{{ agent.response.speech.plain.speech }}

        '
      final_delay: 0
      tts_platform: google_translate
      language: iw
      chime_path: choir
      join_players: true
      unjoin_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
    enabled: true
  mode: single
- id: oref_alert_time_to_shelter_countdown
  alias: Pikud HaOref routine
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.oref_alert
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
    from: 'off'
    trigger: state
  actions:
  - action: scene.create
    metadata: {}
    data:
      scene_id: before_alert
      snapshot_entities:
      - light.wled_backlight_tv
      - light.entrance_bulb
      - light.wled_kitchen
  - data:
      title: התרעה
      message: בפתח תקווה
    action: notify.home_assistant_telegram
  - metadata: {}
    data:
      transition: 5
      kelvin: 2325
      brightness_pct: 60
    target:
      entity_id:
      - light.wled_backlight_tv
      - light.wled_kitchen
      - light.entrance_bulb
    action: light.turn_on
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.oref_alert
      to: 'off'
      trigger: state
    timeout:
      hours: 0
      minutes: 15
      seconds: 10
      milliseconds: 0
  - data:
      message: אפשר לצאת מהמה מד
      chime_path: classical
      cache: true
      announce: true
      language: iw
      tts_platform: google_translate
      end_chime_path: classical
      offset: 1000
      final_delay: 1000
      volume_level: 0.4
    target:
      entity_id: media_player.sonos_living_room
    action: chime_tts.say
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - action: scene.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_alert
  - action: scene.delete
    metadata: {}
    data: {}
    target:
      entity_id: scene.before_alert
  mode: queued
  max: 10
- id: alert_picking_yair
  alias: Alert when picking Yair
  description: ''
  trigger:
  - platform: zone
    entity_id: person.aviad
    zone: zone.school
    event: enter
  - platform: zone
    entity_id: person.noga
    zone: zone.school
    event: enter
  condition:
  - condition: template
    value_template: "{{ state_attr(trigger.entity_id,\n    'friendly_name') == states('input_select.who_picking_the_kids')
      }}"
  - condition: not
    conditions:
    - condition: state
      entity_id: todo.things_yair_took_to_school
      state: '0'
  - condition: time
    after: '11:30:00'
    before: '17:00:00'
  - condition: template
    value_template: '{{(as_timestamp(now()) - as_timestamp(state_attr(''automation.alert_when_picking_yair'',
      ''last_triggered'') | default(0)) | int > 21600 )}}'
    enabled: true
  action:
  - service: todo.get_items
    data:
      status: needs_action
    target:
      entity_id: todo.things_yair_took_to_school
    response_variable: service_result
  - service: notify.mobile_app_{{ state_attr(trigger.entity_id, 'id') }}_phone
    data:
      title: לוודא שיאיר לקח
      message: '{{ service_result[''todo.things_yair_took_to_school''][''items'']
        | map(attribute=''summary'') | join('' '') }}'
  mode: single
- id: who_pick_kids
  alias: Who's picking the kids
  description: ''
  triggers:
  - at: 08:00:00
    trigger: time
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: time
        weekday:
        - tue
        - wed
      sequence:
      - metadata: {}
        data:
          option: Noga
        target:
          entity_id: input_select.who_picking_the_kids
        action: input_select.select_option
    - conditions:
      - condition: time
        weekday:
        - sun
        - thu
        - fri
      sequence:
      - metadata: {}
        data:
          option: Aviad
        target:
          entity_id: input_select.who_picking_the_kids
        action: input_select.select_option
  mode: single
- id: shabbat_4
  alias: Shabbat 4 - rain routine
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.is_raining
    for:
      hours: 0
      minutes: 20
      seconds: 0
    to: 'on'
    id: raining
  - platform: state
    entity_id:
    - binary_sensor.is_raining
    for:
      hours: 0
      minutes: 20
      seconds: 0
    to: 'off'
    id: not_raining
  condition:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: time
    after: 07:00:00
    before: input_datetime.shabbat_lights_out
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.is_raining
        state: 'on'
      - condition: numeric_state
        entity_id: cover.switcher_runner
        above: 25
        attribute: current_position
      sequence:
      - service: cover.set_cover_position
        metadata: {}
        data:
          position: 19
        target:
          entity_id: cover.switcher_runner
      - if:
        - condition: state
          entity_id: light.living_room_lights
          state: 'off'
        then:
        - service: light.turn_on
          metadata: {}
          data: {}
          target:
            entity_id: light.living_room_lights
    - conditions:
      - condition: state
        entity_id: binary_sensor.is_raining
        state: 'off'
      - condition: numeric_state
        entity_id: cover.switcher_runner
        attribute: current_position
        below: 25
      sequence:
      - service: cover.open_cover
        target:
          entity_id:
          - cover.switcher_runner
        data: {}
    default: []
  mode: single
- id: alert_and_speak_day_agenda_test
  alias: Alert and speak day agenda - testing
  description: ''
  triggers:
  - at: 07:00:00
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Home
  actions:
  - data: {}
    enabled: true
    action: script.set_up_sonos_group
  - variables:
      long: "בוקר! היום בפתח תקווה מזג האוויר יהיה בהיר וחם, עם טמפרטורת\n     מקסימום
        של 34 מעלות צלזיוס. שימו לב לשתות הרבה מים כדי להישאר רעננים.\n\n\n     בהמשך
        היום, יש לכם אירוע חשוב בלוח הזמנים: תרופות לאילה בערב בשעה\n     18:00. אל
        תשכחו לסמן זאת בלוח הזמנים שלכם.\n\n\n     היום הוא כ\"ט אייר. האם ידעתם שב-6
        ביוני 1944, החל מבצע 'D-Day' הפולש\n     לאירופה במלחמת העולם השנייה? תמיד
        מעניין לדעת קצת היסטוריה על היום\n     הזה.\n     \n"
  - action: tts.google_say
    metadata: {}
    data:
      language: iw
      entity_id: media_player.sonoses
      message: '{{ long.split("\n\n")[0] }}

        '
    enabled: false
  - data:
      offset: 0
      final_delay: 0
      message: '{{ long.split("\n\n")[0] }}

        '
      tts_platform: google_translate
      language: iw
      chime_path: choir
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
    enabled: true
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: paused
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
    enabled: false
  - data:
      message: '{{ long.split("\n\n")[1] }}

        '
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
    enabled: false
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: paused
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
    enabled: false
  - data:
      message: '{{ long.split("\n\n")[2] }}

        '
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
    enabled: false
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: paused
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
    enabled: false
  - data:
      message: '{{ long.split("\n\n")[3:] }}

        '
      tts_platform: google_translate
      language: iw
      join_players: true
    target:
      entity_id:
      - media_player.sonos_kids_bedroom
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
    enabled: false
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_living_room
      to: paused
      trigger: state
    timeout:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
    enabled: false
  - data: {}
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
    enabled: true
    action: media_player.unjoin
  mode: single
- id: one_time_automation_office_md
  alias: One time automation - office motion
  description: ''
  trigger:
  - platform: time
    at: 08:00:00
    enabled: true
  condition: []
  action:
  - service: automation.turn_on
    data: {}
    target:
      entity_id:
      - automation.office_motion_detection
    enabled: true
  - service: automation.turn_off
    data:
      stop_actions: true
    enabled: true
    target:
      entity_id: automation.one_time_automation_office_motion
  mode: single
- id: alert_pending_updates
  alias: Alert when pending updates
  description: ''
  use_blueprint:
    path: mdegat01/update_notifications.yaml
    input:
      update_entities:
      - update.adaptive_lighting_update
      - update.adguard_home_update
      - update.bathroom_bulb_firmware
      - update.bed_motion_sensor_firmware
      - update.bedroom_temperature_sensor_firmware
      - update.card_mod_update
      - update.chime_tts_update
      - update.door_sensor_firmware
      - update.dreame_vacuum_update
      - update.duck_dns_update
      - update.esphome_update
      - update.formula_one_card_update
      - update.hacs_update
      - update.home_assistant_core_update
      - update.home_assistant_google_drive_backup_update
      - update.home_assistant_operating_system_update
      - update.home_assistant_supervisor_update
      - update.hyperion_ng_update
      - update.israel_meteorological_service_sensor_update
      - update.kitchen_motion_sensor_firmware
      - update.kitchen_switch_firmware
      - update.living_room_door_large_firmware
      - update.living_room_door_small_firmware
      - update.living_room_temperature_sensor_firmware
      - update.living_room_window_large_firmware
      - update.living_room_window_small_firmware
      - update.local_tuya_update
      - update.mini_graph_card_update
      - update.mosquitto_broker_update
      - update.mushroom_update
      - update.nginx_home_assistant_ssl_proxy_update
      - update.oref_alert_update
      - update.parent_bathroom_bulb_firmware
      - update.pirate_weather_update
      - update.qbittorrent_update
      - update.smart_plug_kids_bedroom_firmware
      - update.studio_code_server_update
      - update.vertical_stack_in_card_update
      - update.washing_machine_contact_sensor_firmware
      - update.wled_backlight_tv_firmware
      - update.xiaomi_vacuum_map_card_update
      - update.average_sensor_update
      - update.balcony_bulb_firmware
      - update.closet_bulb_firmware
      - update.israel_electric_corporation_iec_update
      - update.alexa_media_player_update
      - update.apexcharts_card_update
      - update.bazarr_update
      - update.prowlarr_update
      - update.radarr_update
      - update.raspberry_pi_gpio_update
      - update.sonarr_update
      - update.tailscale_update
      - update.advanced_ssh_web_terminal_update
      - update.hass_agent_update
      - update.bedroom_occupancy_firmware
      - update.music_assistant_update
      - update.city_mind_water_meter_update
      - update.mini_pc_fingerbot_firmware
      - update.spook_your_homie_update
      - update.firemote_card_update
      - update.file_editor_update
      - update.spotifyplus_update
      - update.wled_kitchen_firmware
      mobile_app_device: 4214920656084e3e0376f9a6c7b2eb48
      reminder_hours: ''
      only_after: 08:00:00
      only_before: '22:00:00'
      mobile_app_device_2: 4214920656084e3e0376f9a6c7b2eb48
- id: zigbee_switch_closet
  alias: Zigbee closet switch automation
  description: ''
  use_blueprint:
    path: homeassistant/sonoff_switch.yaml
    input:
      sonoff_button: 6d651c2bdf2caa74821a4fb0c684ef6f
      toggle_action:
      - service: light.toggle
        data:
          color_temp: 153
          brightness_pct: 100
        target:
          entity_id: light.closet_bulb
      on_action: []
- id: echo_volume_routine
  alias: Projector in bedroom routine
  description: ''
  triggers:
  - entity_id:
    - remote.mibox3
    id: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
    to: 'on'
    trigger: state
  - entity_id:
    - remote.mibox3
    id: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 0
    enabled: true
    to: 'off'
    from: 'on'
    trigger: state
  conditions: []
  actions:
  - if:
    - condition: trigger
      id:
      - 'off'
    then:
    - metadata: {}
      data:
        volume_level: 0.25
      target:
        entity_id: media_player.bedroom_echo_dot
      action: media_player.volume_set
    else:
    - metadata: {}
      data:
        volume_level: 1
      target:
        entity_id: media_player.bedroom_echo_dot
      action: media_player.volume_set
    - target:
        entity_id: media_player.mibox
      data:
        volume_level: 0.6
      action: media_player.volume_set
    - metadata: {}
      data: {}
      target:
        entity_id:
        - light.bed_led_strip
        - light.parent_bathroom_bulb
        - light.closet_bulb
      action: light.turn_off
  mode: single
- id: home_wifi_routine
  alias: Home WIFI connection routine
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.aviad_phone_wifi_connection
  condition: []
  action:
  - delay:
      hours: 0
      minutes: 0
      seconds: 15
      milliseconds: 0
  - service: notify.mobile_app_aviad_phone
    data:
      message: command_broadcast_intent
      data:
        intent_package_name: com.tailscale.ipn
        intent_action: com.tailscale.ipn.{{ "DIS" if "Levy" in states('sensor.aviad_phone_wifi_connection')  else
          ""}}CONNECT_VPN
    enabled: false
  - if:
    - condition: template
      value_template: '{{ states(''sensor.aviad_phone_wifi_connection'') in ["Levy",
        "Levy_5G", "Levy_EXT"] }}'
    then:
    - service: mqtt.publish
      metadata: {}
      data:
        topic: location/aviad_wifi
        payload: home
        retain: true
    else:
    - service: mqtt.publish
      metadata: {}
      data:
        topic: location/aviad_wifi
        payload: not_home
        retain: true
  mode: restart
- id: shabbat_1_1
  alias: Shabbat 1.1 - Kriat Shma when early shabbat
  description: ''
  trigger:
  - platform: template
    value_template: '{{ as_timestamp(states(''sensor.jewish_calendar_t_set_hakochavim''))|timestamp_custom(''%H:%M'',
      true) == as_timestamp(now())|timestamp_custom(''%H:%M'', true) }}'
  condition:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  - condition: state
    entity_id: binary_sensor.is_early_shabbat
    state: 'on'
  - condition: not
    conditions:
    - condition: time
      weekday:
      - sat
  action:
  - service: chime_tts.say
    data:
      chime_path: choir
      cache: true
      tts_platform: google_translate
      language: iw
      join_players: true
      message: לא לשכוח לחזור על קריאת שמע
    target:
      entity_id:
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
  mode: single
- id: shabbat_1_2
  alias: Shabbat 1.2 - wake up
  description: ''
  triggers:
  - at: input_datetime.shabbat_morning_lights_on
    trigger: time
  conditions:
  - condition: state
    entity_id: input_select.mode
    state: Shabbat
  actions:
  - repeat:
      count: 2
      sequence:
      - metadata: {}
        data: {}
        action: script.echo_say_the_time
      - delay:
          hours: 0
          minutes: 30
          seconds: 0
          milliseconds: 0
  mode: single
- id: '1716104348579'
  alias: Kids in school routine
  description: ''
  triggers:
  - at: 08:30:00
    id: 'off'
    trigger: time
  - at: '15:30:00'
    id: 'on'
    trigger: time
  - trigger: state
    entity_id:
    - input_select.mode
    to: Home
    id: 'on'
  conditions:
  - condition: state
    entity_id: binary_sensor.is_school_vacation
    state: 'off'
  - condition: state
    entity_id: input_select.mode
    state: Home
  - condition: time
    weekday:
    - sun
    - mon
    - tue
    - wed
    - thu
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: trigger
        id:
        - 'on'
      - condition: time
        after: '15:00:00'
    - condition: trigger
      id:
      - 'off'
  actions:
  - target:
      entity_id: light.bathroom_bulb
    action: light.turn_{{ trigger.id }}
  - if:
    - condition: trigger
      id:
      - 'off'
    - condition: state
      entity_id: binary_sensor.is_raining
      state: 'off'
    - condition: state
      entity_id: binary_sensor.is_dst
      state: 'on'
    then:
    - metadata: {}
      data:
        position: 35
      target:
        entity_id: cover.switcher_runner
      action: cover.set_cover_position
  mode: single
- id: '1718041496620'
  alias: Home assistant starts routine
  description: ''
  trigger:
  - platform: homeassistant
    event: start
  condition: []
  action:
  - delay:
      hours: 0
      minutes: 0
      seconds: 30
      milliseconds: 0
  - service: localtuya.reload
    data: {}
  mode: single
- id: '1719246942820'
  alias: Post electric outage
  description: ''
  trigger:
  - platform: state
    entity_id:
    - light.parent_bathroom_small_bulb
    to: unavailable
    for:
      hours: 0
      minutes: 15
      seconds: 0
  condition: []
  action:
  - service: localtuya.reload
    data: {}
  mode: single
- id: '1720729188404'
  alias: Alert when Samba disconnected
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - sensor.system_monitor_disk_free_media_smb
    to: unavailable
    for:
      hours: 0
      minutes: 5
      seconds: 0
    id: smb
  - trigger: state
    entity_id:
    - person.aviad
    to: home
    id: smb
  conditions:
  - condition: state
    entity_id: sensor.system_monitor_disk_free_media_smb
    state: unavailable
  actions:
  - metadata: {}
    data:
      message: Samba disk disconnected
      data:
        tag: smb-disconnected
    action: notify.mobile_app_aviad_phone
  - wait_for_trigger:
    - entity_id:
      - sensor.system_monitor_disk_free_media_smb
      trigger: state
      from: unavailable
  - data:
      message: clear_notification
      data:
        tag: smb-disconnected
    action: notify.mobile_app_aviad_phone
  mode: single
- id: '1721752734315'
  alias: Alert when Tzet Hatzom
  description: ''
  triggers:
  - entity_id:
    - sensor.jewish_calendar_holiday
    attribute: type
    from: FAST_DAY
    trigger: state
  conditions: []
  actions:
  - wait_for_trigger:
    - entity_id:
      - sensor.jewish_calendar_t_set_hakochavim
      trigger: state
    continue_on_timeout: true
    timeout:
      hours: 0
      minutes: 24
      seconds: 0
      milliseconds: 0
  - data:
      message: נגמר הצום! אפשר לאכול ולשתות! בתיאבון!
      tts_platform: google_translate
      join_players: true
      unjoin_players: true
      cache: true
      announce: true
      fade_audio: true
      language: iw
      chime_path: classical
      volume_level: 0.5
    target:
      entity_id:
      - media_player.sonos_kitchen
      - media_player.sonos_living_room
    action: chime_tts.say
  - data:
      message: 'Tzet HaTzom '
    action: notify.alexa_media_bedroom_echo_dot
  - if:
    - condition: state
      entity_id: person.aviad
      state: not_home
    then:
    - metadata: {}
      data:
        message: צאת הצום
      action: notify.mobile_app_aviad_phone
  mode: single
- id: '1724096343618'
  alias: Recover qbittorrent
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.qbittorrent_status
    to: downloading
    for:
      hours: 1
      minutes: 0
      seconds: 0
  condition: []
  action:
  - action: telegram_bot.send_message
    metadata: {}
    data:
      title: Restarting qbittorrent
      message: ' '
  - action: hassio.addon_restart
    metadata: {}
    data:
      addon: db21ed7f_qbittorrent
  mode: single
- id: '1728804453243'
  alias: Tag Sofa is scanned
  description: ''
  triggers:
  - trigger: tag
    tag_id: ee249a7f-c780-4c3e-a649-1027e2c37ec7
  conditions: []
  actions:
  - action: scene.turn_on
    metadata: {}
    target:
      entity_id: scene.movie
    data: {}
  - action: button.press
    metadata: {}
    data: {}
    target:
      entity_id: button.wake_on_lan_mitv
  - delay:
      hours: 0
      minutes: 1
      seconds: 0
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.wled_kitchen
  mode: single
- id: '1728804893672'
  alias: When Movie scene activated
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - scene.movie
  conditions: []
  actions:
  - action: button.press
    metadata: {}
    data: {}
    target:
      entity_id: button.wake_on_lan_mitv
  mode: single
- id: '1729492826254'
  alias: test template
  description: ''
  triggers: []
  conditions: []
  actions:
  - action: persistent_notification.create
    metadata: {}
    data:
      message: Success
    enabled: false
  - action: script.get_random_song_from_playlist
    metadata: {}
    data:
      playlist_id: 07c13wipxpcwEl7eMRJRjk
    enabled: false
  mode: single
- id: '1730829192764'
  alias: Alert when Mini PC disconnected
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.mini_pc
    to: 'off'
    trigger: state
    id: minipc
  - trigger: homeassistant
    event: start
  conditions: []
  actions:
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - if:
    - condition: state
      entity_id: binary_sensor.mini_pc
      state: 'off'
    then:
    - metadata: {}
      data:
        message: Mini PC disconnected
        data:
          actions:
          - action: finger_bot_toggle
            title: Turn on
          tag: mini-pc-disconnected
      action: notify.mobile_app_aviad_phone
    - wait_for_trigger:
      - event_type: mobile_app_notification_action
        event_data:
          tag: mini-pc-disconnected
        trigger: event
      - entity_id:
        - binary_sensor.mini_pc
        to: 'on'
        trigger: state
      timeout:
        hours: 1
        minutes: 0
        seconds: 0
        milliseconds: 0
    - if:
      - condition: template
        value_template: '{{ wait.trigger and wait.trigger.event and wait.trigger.event.data
          and wait.trigger.event.data.action == ''finger_bot_toggle'' }}'
      then:
      - target:
          entity_id: switch.mini_pc_fingerbot_switch
        data: {}
        action: switch.toggle
      - data:
          message: clear_notification
          data:
            tag: mini-pc-disconnected
        action: notify.mobile_app_aviad_phone
      else:
      - data:
          message: clear_notification
          data:
            tag: mini-pc-disconnected
        action: notify.mobile_app_aviad_phone
  mode: restart
- id: '1732133474783'
  alias: Kitchen WLED Music
  description: ''
  triggers:
  - entity_id:
    - media_player.sonos_kitchen
    for:
      hours: 0
      minutes: 0
      seconds: 10
    to: playing
    trigger: state
  conditions:
  - condition: state
    entity_id: switch.wled_backlight_tv_sync_send
    state: 'off'
  actions:
  - data:
      brightness_pct: 90
      effect: '{{ state_attr("light.wled_kitchen", "effect_list")[1:118] | reject("equalto",
        "RSVD") | list | random }}'
    target:
      entity_id: light.wled_kitchen
    action: light.turn_on
  - target:
      entity_id: select.wled_kitchen_color_palette
    data:
      option: '{{ state_attr(''select.wled_kitchen_color_palette'', ''options'') |
        random }}'
    action: select.select_option
  - wait_for_trigger:
    - entity_id:
      - media_player.sonos_kitchen
      from: playing
      for:
        hours: 0
        minutes: 0
        seconds: 7
      trigger: state
    timeout:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - data: {}
    target:
      entity_id: light.wled_kitchen
    action: light.turn_off
  mode: restart
- id: '1732136443914'
  alias: Kitchen WLED motion sensor
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.espresense_kitchen_occupancy
    to: 'on'
    trigger: state
    from: 'off'
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: input_select.mode
      state: Shabbat
    - condition: state
      entity_id: binary_sensor.jewish_calendar_issur_melacha_in_effect
      state: 'on'
  - condition: state
    entity_id: sun.sun
    state: below_horizon
  - condition: state
    entity_id: light.kitchen_switch
    state: 'off'
  actions:
  - data:
      kelvin: 6500
      brightness_pct: 50
      transition: 10
      effect: Solid
    action: light.turn_on
    target:
      entity_id: light.wled_kitchen
  - wait_for_trigger:
    - entity_id:
      - binary_sensor.espresense_kitchen_occupancy
      from: 'on'
      to: 'off'
      for:
        hours: 0
        minutes: 2
        seconds: 0
      trigger: state
    timeout:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - data:
      transition: 15
    action: light.turn_off
    target:
      entity_id: light.wled_kitchen
  mode: restart
- id: '1732870692023'
  alias: Kitchen WLED routine
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - light.wled_kitchen
    to: 'on'
  conditions: []
  actions:
  - action: light.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: light.wled_kitchen_main
  mode: single
- id: '1733873712830'
  alias: Alert when no free space
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.desktop_levy_storage_c_free_space
    - sensor.system_monitor_disk_free
    - sensor.system_monitor_disk_free_media_smb
    below: 30
  conditions: []
  actions:
  - action: notify.home_assistant_telegram
    metadata: {}
    data:
      message: '{{ trigger.to_state.name }} is running out of free space'
  mode: single
- id: '1736891049343'
  alias: Alert when needs to water the plant
  description: ''
  triggers:
  - trigger: time
    at: '18:00:00'
  conditions:
  - condition: time
    weekday:
    - thu
    - wed
    - tue
    - mon
    - sun
  - condition: numeric_state
    entity_id: sensor.plant_soil_tester_soil_moisture
    below: 85
  - condition: state
    entity_id: input_select.mode
    state: Home
  actions:
  - action: notify.aviad_and_noga_mobiles
    metadata: {}
    data:
      message: להשקות אותי בבקשה
      title: עציץ בסלון
  - action: chime_tts.say
    metadata: {}
    data:
      message: נא להשקות את העציץ בסלון
      tts_platform: google_translate
      join_players: true
      unjoin_players: true
      cache: true
      announce: true
      fade_audio: true
      language: iw
      chime_path: toast
    target:
      entity_id:
      - media_player.sonos_living_room
      - media_player.sonos_kitchen
      - media_player.sonos_kids_bedroom
  mode: single
